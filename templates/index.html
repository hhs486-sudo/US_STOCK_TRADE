{% extends "base.html" %}
{% block title %}ëŒ€ì‹œë³´ë“œ â€” ë¯¸êµ­ì£¼ì‹ ì¶”ì²œ{% endblock %}

{% block content %}

<!-- ì‹œì¥ ì‹¬ë¦¬ ì§€í‘œ -->
<div class="row g-3 mb-4">
  <div class="col-12"><h5 class="text-muted mb-1">ì‹œì¥ ì‹¬ë¦¬ ì§€í‘œ</h5></div>

  <!-- Fear & Greed -->
  <div class="col-6 col-md-2">
    <div class="card h-100 text-center p-3">
      <div class="text-muted small"
        data-bs-toggle="tooltip"
        data-bs-html="true"
        data-bs-title="CNN íˆ¬ìì‹¬ë¦¬ ì§€ìˆ˜.<br>0=ê·¹ë„ê³µí¬(ë§¤ìˆ˜ê¸°íšŒ),<br>100=ê·¹ë„íƒìš•(ê³¼ì—´).<br>25ì´í•˜ â†’ ê³µí¬ ì ìˆ˜ ìµœëŒ€">
        Fear & Greed â„¹
      </div>
      {% if fear_greed.value is not none %}
        <div class="display-5 fw-bold mt-1" style="color:{{ fear_greed.color }}">
          {{ fear_greed.value }}
        </div>
        <div class="badge mt-1" style="background:{{ fear_greed.color }}">
          {{ fear_greed.label }}
        </div>
        {% if fear_greed.prev_1w %}
          <div class="text-muted mt-1" style="font-size:0.72rem">
            1ì£¼ì „ {{ fear_greed.prev_1w }} / 1ë‹¬ì „ {{ fear_greed.prev_1m }}
          </div>
        {% endif %}
        <div class="text-muted" style="font-size:0.68rem">{{ fear_greed.source }}</div>
      {% else %}
        <div class="text-muted mt-2">N/A</div>
      {% endif %}
    </div>
  </div>

  <!-- VIX -->
  <div class="col-6 col-md-2">
    <div class="card h-100 text-center p-3">
      <div class="text-muted small"
        data-bs-toggle="tooltip"
        data-bs-html="true"
        data-bs-title="ì‹œì¥ ë³€ë™ì„± ì§€ìˆ˜.<br>20â†‘ ë¶ˆì•ˆ,<br>30â†‘ ê³µí¬,<br>40â†‘ ê·¹ë„ê³µí¬.<br>ë†’ì„ìˆ˜ë¡ ë§¤ìˆ˜ ê¸°íšŒ ê°€ëŠ¥">
        VIX ì§€ìˆ˜ â„¹
      </div>
      {% if vix.current is not none %}
        <div class="display-5 fw-bold mt-1
          {% if vix.level == 'extreme' %}text-danger
          {% elif vix.level == 'high' %}text-warning
          {% else %}text-success{% endif %}">
          {{ vix.current }}
        </div>
        <div class="small text-muted">
          {{ vix.change_pct }}%
          {% if vix.level == 'extreme' %}ğŸ”´ ê·¹ë„ ê³µí¬
          {% elif vix.level == 'high' %}ğŸŸ  ë†’ìŒ
          {% elif vix.level == 'normal' %}ğŸŸ¡ ë³´í†µ
          {% else %}ğŸŸ¢ ë‚®ìŒ{% endif %}
        </div>
      {% else %}
        <div class="text-muted mt-2">N/A</div>
      {% endif %}
    </div>
  </div>

  <!-- Market RSI -->
  <div class="col-6 col-md-2">
    <div class="card h-100 text-center p-3">
      <div class="text-muted small"
        data-bs-toggle="tooltip"
        data-bs-html="true"
        data-bs-title="14ì¼ ìƒëŒ€ê°•ë„ì§€ìˆ˜.<br>30ì´í•˜=ê³¼ë§¤ë„(ë§¤ìˆ˜ê¸°íšŒ),<br>70ì´ìƒ=ê³¼ë§¤ìˆ˜(ê³¼ì—´). S&amp;P500 ê¸°ì¤€ ì ìš©">
        ì§€ìˆ˜ RSI(14) â„¹
      </div>
      {% set sp = market_rsi.sp500 %}
      {% set nq = market_rsi.nasdaq %}
      {% if sp.rsi is not none %}
        <div class="mt-1">
          <span class="text-muted small">S&amp;P500</span>
          <span class="fw-bold ms-1
            {% if sp.level == 'oversold' %}text-danger
            {% elif sp.level == 'overbought' %}text-success
            {% else %}text-warning{% endif %}">
            {{ sp.rsi }}
          </span>
        </div>
        <div>
          <span class="text-muted small">NASDAQ</span>
          <span class="fw-bold ms-1
            {% if nq.level == 'oversold' %}text-danger
            {% elif nq.level == 'overbought' %}text-success
            {% else %}text-warning{% endif %}">
            {{ nq.rsi if nq.rsi else 'N/A' }}
          </span>
        </div>
        {% if sp.level == 'oversold' %}
          <div class="badge bg-danger mt-1">ê³¼ë§¤ë„</div>
        {% elif sp.level == 'overbought' %}
          <div class="badge bg-success mt-1">ê³¼ë§¤ìˆ˜</div>
        {% else %}
          <div class="badge bg-secondary mt-1">ì¤‘ë¦½</div>
        {% endif %}
      {% else %}
        <div class="text-muted mt-2">N/A</div>
      {% endif %}
    </div>
  </div>

  <!-- CPI -->
  <div class="col-6 col-md-2">
    <div class="card h-100 text-center p-3">
      <div class="text-muted small"
        data-bs-toggle="tooltip"
        data-bs-html="true"
        data-bs-title="ì†Œë¹„ìë¬¼ê°€ ìƒìŠ¹ë¥ (YoY).<br>ì—°ì¤€ ëª©í‘œ 2%.<br>ë†’ì„ìˆ˜ë¡ ê¸ˆë¦¬ ì¸ìƒ ì••ë ¥ â†’ ì¦ì‹œ ë¶€ë‹´">
        CPI (YoY) â„¹
      </div>
      {% if cpi.available %}
        <div class="display-5 fw-bold mt-1
          {% if cpi.latest_value and cpi.latest_value > 4 %}text-danger
          {% elif cpi.latest_value and cpi.latest_value > 2.5 %}text-warning
          {% else %}text-success{% endif %}">
          {{ cpi.latest_value }}%
        </div>
        <div class="small text-muted">
          {{ cpi.latest_date }}
          {% if cpi.trend == 'down' %}â†“ í•˜ë½{% elif cpi.trend == 'up' %}â†‘ ìƒìŠ¹{% else %}â†’ ë³´í•©{% endif %}
        </div>
      {% else %}
        <div class="text-muted mt-2 small">
          {% if cpi.reason == 'FRED_API_KEY not set' %}FRED API í‚¤ ë¯¸ì„¤ì •
          {% else %}N/A{% endif %}
        </div>
      {% endif %}
    </div>
  </div>

  <!-- ì¥ë‹¨ê¸° ê¸ˆë¦¬ì°¨ -->
  <div class="col-6 col-md-2">
    <div class="card h-100 text-center p-3">
      <div class="text-muted small"
        data-bs-toggle="tooltip"
        data-bs-html="true"
        data-bs-title="10ë…„ë¬¼-2ë…„ë¬¼ ê¸ˆë¦¬ì°¨.<br>ìŒìˆ˜(-) ì—­ì „ ì‹œ 6~18ê°œì›” ë‚´ ê²½ê¸°ì¹¨ì²´ ì—­ì‚¬ì  ì„ í–‰ì§€í‘œ">
        ì¥ë‹¨ê¸° ê¸ˆë¦¬ì°¨ â„¹
      </div>
      {% if yield_curve.available %}
        <div class="display-5 fw-bold mt-1
          {% if yield_curve.status == 'deeply_inverted' %}text-danger
          {% elif yield_curve.status == 'inverted' %}text-warning
          {% elif yield_curve.status == 'flat' %}text-info
          {% else %}text-success{% endif %}">
          {{ '%+.2f'|format(yield_curve.spread) }}%
        </div>
        <div class="small text-muted">{{ yield_curve.status_label }}</div>
        <div class="text-muted" style="font-size:0.68rem">
          10Y {{ yield_curve.rate_10y }}% / 2Y {{ yield_curve.rate_2y }}%
        </div>
      {% else %}
        <div class="text-muted mt-2 small">N/A</div>
      {% endif %}
    </div>
  </div>

  <!-- M2 í†µí™”ëŸ‰ ì¦ê°€ìœ¨ -->
  <div class="col-6 col-md-2">
    <div class="card h-100 text-center p-3">
      <div class="text-muted small"
        data-bs-toggle="tooltip"
        data-bs-html="true"
        data-bs-title="M2 í†µí™”ëŸ‰ YoY ì¦ê°€ìœ¨(FRED).<br>ì‹œì¥ ìœ ë™ì„± ì§€í‘œ.<br>0%â†“ ìˆ˜ì¶•â†’ì¦ì‹œ ì••ë°•(-7~-15ì ),<br>5%â†‘ í™•ì¥â†’ì¦ì‹œ ìš°í˜¸">
        M2 ì¦ê°€ìœ¨ â„¹
      </div>
      {% if m2.available %}
        <div class="display-5 fw-bold mt-1" style="color:{{ m2.color }}">
          {{ m2.latest_value }}%
        </div>
        <div class="small text-muted">
          {{ m2.latest_date }}
          {% if m2.trend == 'down' %}â†“ í•˜ë½{% elif m2.trend == 'up' %}â†‘ ìƒìŠ¹{% else %}â†’ ë³´í•©{% endif %}
        </div>
        <div class="badge mt-1" style="background:{{ m2.color }}">{{ m2.level_label }}</div>
        {% if m2.consecutive_months %}
          <div class="text-muted mt-1" style="font-size:0.68rem"
            data-bs-toggle="tooltip" data-bs-html="true"
            data-bs-title="M2 ì¶”ì„¸ê°€ {{ m2.consecutive_months }}ê°œì›” ì—°ì† ìœ ì§€ ì¤‘.<br>6~12ê°œì›” ì‹œì°¨ë¡œ ì‹¤ì œ ì‹œì¥ ì˜í–¥ ë°˜ì˜.<br>7ê°œì›”â†‘ ìˆ˜ì¶• = ì‹¤ì œ ì˜í–¥ ìµœëŒ€ êµ¬ê°„.">
            {{ m2.consecutive_months }}ê°œì›” ì—°ì† â„¹
          </div>
        {% endif %}
      {% else %}
        <div class="text-muted mt-2 small">
          {% if m2.reason == 'FRED_API_KEY not set' %}FRED API í‚¤ ë¯¸ì„¤ì •
          {% else %}N/A{% endif %}
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- ê³µí¬ ì¢…í•© ì ìˆ˜ -->
<div class="card mb-4 p-3">
  <div class="d-flex align-items-center gap-3">
    <div>
      <div class="text-muted small">ì‹œì¥ ê³µí¬ ì¢…í•© ì ìˆ˜</div>
      <div class="fw-bold fs-4
        {% if fear_score >= 60 %}text-danger
        {% elif fear_score >= 40 %}text-warning
        {% else %}text-success{% endif %}">
        {{ fear_score }} / 100
      </div>
    </div>
    <div class="flex-grow-1">
      <div class="progress" style="height:14px">
        <div class="progress-bar
          {% if fear_score >= 70 %}bg-danger
          {% elif fear_score >= 50 %}bg-warning
          {% elif fear_score >= 30 %}bg-info
          {% else %}bg-success{% endif %}"
          style="width:{{ fear_score }}%"></div>
      </div>
    </div>
    <div class="text-muted small">
      {% if fear_score >= 70 %}ğŸ”´ ê°•ë ¥ ë§¤ìˆ˜ ê¸°íšŒ
      {% elif fear_score >= 50 %}ğŸŸ  ë§¤ìˆ˜ ê³ ë ¤ êµ¬ê°„
      {% elif fear_score >= 30 %}ğŸ”µ ì£¼ì˜ êµ¬ê°„
      {% else %}ğŸŸ¢ ì•ˆì • êµ¬ê°„{% endif %}
    </div>
  </div>
</div>

<!-- Watchlist ì¶”ì²œ ìˆœìœ„ -->
<div class="d-flex justify-content-between align-items-center mb-2">
  <h5 class="mb-0">ê´€ì‹¬ ì¢…ëª© ì¶”ì²œ ìˆœìœ„</h5>
  <div class="d-flex align-items-center gap-2">
    <!-- ê°€ê²© ê°±ì‹  ìƒíƒœ í‘œì‹œ -->
    <span id="priceUpdateBadge" class="badge bg-secondary" style="font-size:0.72rem"></span>
    <a href="/watchlist" class="btn btn-outline-secondary btn-sm">+ ì¢…ëª© ì¶”ê°€</a>
  </div>
</div>

{% if not stocks %}
  <div class="alert alert-info">
    ë“±ë¡ëœ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤. <a href="/watchlist">Watchlist</a>ì—ì„œ ì¢…ëª©ì„ ì¶”ê°€í•˜ì„¸ìš”.
  </div>
{% else %}
  <div class="table-responsive">
    <table class="table table-hover align-middle">
      <thead class="table-dark">
        <tr>
          <th>ìˆœìœ„</th>
          <th>ì¢…ëª©</th>
          <th>í˜„ì¬ê°€</th>
          <th>ATH ëŒ€ë¹„ ë‚™í­</th>
          <th>Buy ë¹„ìœ¨</th>
          <th>ëª©í‘œê°€ Upside</th>
          <th>ì¶”ì²œ ì ìˆ˜</th>
          <th>ë“±ê¸‰</th>
        </tr>
      </thead>
      <tbody>
        {% for s in stocks %}
        <tr data-ticker="{{ s.ticker }}">
          <td class="text-muted rank-cell">{{ loop.index }}</td>
          <td>
            <a href="/stock/{{ s.ticker }}" class="fw-bold text-decoration-none">{{ s.ticker }}</a>
            <div class="text-muted small">{{ s.name[:30] if s.name else '' }}</div>
          </td>
          <td>
            {% if s.current_price %}
              <!-- data-price: JSì—ì„œ ë³€ë™ ê°ì§€ìš© ê¸°ì¤€ê°’ -->
              <span class="price-cell fw-bold" data-ticker="{{ s.ticker }}" data-price="{{ s.current_price }}">
                ${{ "%.2f"|format(s.current_price) }}
              </span>
              <!-- ì „ì¼ ëŒ€ë¹„ ë³€ë™ë¥  í‘œì‹œ (JSê°€ ì±„ì›Œì¤Œ) -->
              <span class="change-cell small" data-ticker="{{ s.ticker }}"></span>
            {% else %}
              <span class="text-muted">N/A</span>
            {% endif %}
          </td>
          <td>
            {% if s.ath_drawdown_pct is not none %}
              <span class="drawdown-cell
                {% if s.ath_drawdown_pct <= -30 %}text-danger fw-bold
                {% elif s.ath_drawdown_pct <= -15 %}text-warning
                {% else %}text-muted{% endif %}"
                data-ticker="{{ s.ticker }}"
                data-drawdown="{{ s.ath_drawdown_pct }}"
                data-ath="{{ s.ath if s.ath is not none else '' }}">
                {{ s.ath_drawdown_pct }}%
              </span>
            {% else %}
              <span class="text-muted">N/A</span>
            {% endif %}
          </td>
          <td>
            {% if s.is_etf %}
              <span class="badge bg-info text-dark">ETF</span>
            {% elif s.buy_ratio_pct is not none %}
              <span class="{% if s.buy_ratio_pct >= 70 %}text-success{% elif s.buy_ratio_pct >= 50 %}text-warning{% else %}text-danger{% endif %}">
                {{ s.buy_ratio_pct }}%
              </span>
            {% else %}
              <span class="text-muted">N/A</span>
            {% endif %}
          </td>
          <td>
            {% if s.target_upside_pct is not none %}
              <span class="{% if s.target_upside_pct > 0 %}text-success{% else %}text-danger{% endif %}">
                {{ '+' if s.target_upside_pct > 0 else '' }}{{ s.target_upside_pct }}%
              </span>
            {% else %}
              <span class="text-muted">N/A</span>
            {% endif %}
          </td>
          <td class="fw-bold score-cell" data-ticker="{{ s.ticker }}" data-score="{{ s.total_score }}">{{ s.total_score }}</td>
          <td>
            <!-- ë“±ê¸‰ ë°°ì§€ í´ë¦­ ì‹œ ìƒì„¸ ë¶„ì„ íŒì—… -->
            <span class="badge grade-badge"
              style="background:{{ s.grade_color }}; cursor:pointer"
              data-ticker="{{ s.ticker }}"
              data-name="{{ s.name }}"
              data-total="{{ s.total_score }}"
              data-grade="{{ s.grade }}"
              data-grade-color="{{ s.grade_color }}"
              data-fear="{{ s.fear_score }}"
              data-drawdown-score="{{ s.drawdown_score }}"
              data-fundamental="{{ s.fundamental_score if s.fundamental_score is not none else '' }}"
              data-recession="{{ s.recession_penalty if s.recession_penalty is defined else 0 }}"
              data-m2-adj="{{ s.m2_adjustment if s.m2_adjustment is defined else 0 }}"
              data-ath-drawdown="{{ s.ath_drawdown_pct }}"
              data-buy-ratio="{{ s.buy_ratio_pct if s.buy_ratio_pct is not none else '' }}"
              data-forward-pe="{{ s.forward_pe if s.forward_pe is not none else '' }}"
              data-roe="{{ s.roe if (s.roe is defined and s.roe is not none) else '' }}"
              data-peg="{{ s.peg if (s.peg is defined and s.peg is not none) else '' }}"
              data-fcf="{{ 'ì–‘í˜¸' if s.fcf_positive else 'ë¶€ì¡±' }}"
              data-is-etf="{{ 'true' if s.is_etf else 'false' }}"
              data-reason="{{ s.reason }}">
              {{ s.grade }}
            </span>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% endif %}

<div class="d-flex justify-content-between align-items-center mt-2">
  <div class="text-muted small">
    â€» ë³¸ ì •ë³´ëŠ” íˆ¬ì ì˜ì‚¬ê²°ì • ì°¸ê³ ìš©ì´ë©°, íˆ¬ì ì†ìµì— ëŒ€í•œ ì±…ì„ì€ íˆ¬ìì ë³¸ì¸ì—ê²Œ ìˆìŠµë‹ˆë‹¤.
  </div>
  <div class="text-muted small" id="lastUpdatedText"></div>
</div>

<!-- â”€â”€ ë“±ê¸‰ ìƒì„¸ ë¶„ì„ ëª¨ë‹¬ â”€â”€ -->
<div class="modal fade" id="gradeModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header" id="modalHeader">
        <h5 class="modal-title" id="modalTitle">ì¢…ëª© ë¶„ì„</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- JSê°€ ì±„ì›Œì¤Œ -->
      </div>
      <div class="modal-footer">
        <small class="text-muted me-auto">â€» ê·œì¹™ ê¸°ë°˜ ì ìˆ˜ë¡œ íˆ¬ì ê²°ì •ì˜ ì°¸ê³  ìë£Œì…ë‹ˆë‹¤.</small>
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">ë‹«ê¸°</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
/* â”€â”€ Bootstrap íˆ´íŒ ì´ˆê¸°í™” â”€â”€ */
document.addEventListener("DOMContentLoaded", function () {
  document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(function (el) {
    new bootstrap.Tooltip(el, { placement: "bottom", trigger: "hover", html: true, sanitize: false });
  });
});

/* â”€â”€ ë“±ê¸‰ ë°°ì§€ í´ë¦­ â†’ ëª¨ë‹¬ ìƒì„¸ ë¶„ì„ â”€â”€ */
document.addEventListener("click", function (e) {
  var badge = e.target.closest(".grade-badge");
  if (!badge) return;

  /* ë°°ì§€ì—ì„œ ë°ì´í„° ì¶”ì¶œ */
  var ticker      = badge.dataset.ticker;
  var name        = badge.dataset.name;
  var total       = parseInt(badge.dataset.total);
  var grade       = badge.dataset.grade;
  var gradeColor  = badge.dataset.gradeColor;
  var fear        = parseInt(badge.dataset.fear);
  var ddScore     = parseInt(badge.dataset.drawdownScore);
  var fundScore   = badge.dataset.fundamental !== "" ? parseInt(badge.dataset.fundamental) : null;
  var recession   = parseInt(badge.dataset.recession || "0");
  var m2Adj       = parseInt(badge.dataset.m2Adj || "0");  /* ì–‘ìˆ˜=ë³´ë„ˆìŠ¤, ìŒìˆ˜=íŒ¨ë„í‹° */
  var athDd       = parseFloat(badge.dataset.athDrawdown);
  var buyRatio    = badge.dataset.buyRatio !== "" ? parseFloat(badge.dataset.buyRatio) : null;
  var fpe         = badge.dataset.forwardPe !== "" ? parseFloat(badge.dataset.forwardPe) : null;
  var roe         = badge.dataset.roe !== "" ? parseFloat(badge.dataset.roe) : null;
  var peg         = badge.dataset.peg !== "" ? parseFloat(badge.dataset.peg) : null;
  var fcf         = badge.dataset.fcf;
  var isEtf       = badge.dataset.isEtf === "true";
  var reason      = badge.dataset.reason;

  /* ëª¨ë‹¬ í—¤ë” ì„¤ì • */
  document.getElementById("modalHeader").style.background = gradeColor + "22";
  document.getElementById("modalTitle").innerHTML =
    ticker + " <small class='text-muted'>" + name.substring(0, 30) + "</small>" +
    " &nbsp;<span class='badge' style='background:" + gradeColor + "'>" + grade + "</span>";

  /* â”€â”€ ì ìˆ˜ í•´ì„ í•¨ìˆ˜ â”€â”€ */
  function fearDesc(s) {
    if (s >= 70) return "ì‹œì¥ ê·¹ë„ ê³µí¬ â€” ì—­ì‚¬ì  ì €ì  ê·¼ì²˜ ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.";
    if (s >= 50) return "ì‹œì¥ ë¶ˆì•ˆÂ·í•˜ë½ â€” ê³µí¬ ë¶„ìœ„ê¸°ê°€ í¼ì ¸ ìˆëŠ” ìƒíƒœì…ë‹ˆë‹¤.";
    if (s >= 30) return "ë‹¤ì†Œ ë¶ˆì•ˆ â€” í•˜ë½ ì••ë ¥ì´ ìˆìœ¼ë‚˜ ì•„ì§ ê³µí¬ ìˆ˜ì¤€ì€ ì•„ë‹™ë‹ˆë‹¤.";
    return "ì‹œì¥ ì•ˆì •Â·íƒìš• ìƒíƒœ â€” ë§¤ìˆ˜ íƒ€ì´ë°ìœ¼ë¡œëŠ” ë¶ˆë¦¬í•©ë‹ˆë‹¤.";
  }
  function ddDesc(d, isEtf) {
    if (d == null) return "ë‚™í­ ë°ì´í„° ì—†ìŒ";
    var pct = Math.abs(d);
    if (isEtf) {
      /* ETFëŠ” ì§€ìˆ˜ì¶”ì¢… íŠ¹ì„±ìƒ ë‚™í­ì´ ì‘ìœ¼ë¯€ë¡œ 5~20% ê¸°ì¤€ ì‚¬ìš© */
      if (pct >= 20) return "ATH ëŒ€ë¹„ " + d + "% â€” ETF ëŒ€í˜• ì¡°ì •, ê°•ë ¥í•œ ë§¤ìˆ˜ êµ¬ê°„";
      if (pct >= 15) return "ATH ëŒ€ë¹„ " + d + "% â€” ETF ìƒë‹¹í•œ ì¡°ì •, ë§¤ìˆ˜ ì ê·¹ ê²€í†  êµ¬ê°„";
      if (pct >= 10) return "ATH ëŒ€ë¹„ " + d + "% â€” ETF ì¤‘ê°„ ì¡°ì •, ë§¤ìˆ˜ ê³ ë ¤ ê°€ëŠ¥";
      if (pct >= 5)  return "ATH ëŒ€ë¹„ " + d + "% â€” ETF ì†Œí­ ì¡°ì •, ì¶”ê°€ í•˜ë½ ê´€ë§ ê¶Œì¥";
      return "ATH ëŒ€ë¹„ " + d + "% â€” ê³ ì  ê·¼ì²˜, ë§¤ìˆ˜ ì£¼ì˜";
    } else {
      /* ì¼ë°˜ ì£¼ì‹ ê¸°ì¤€ 10~50% */
      if (pct >= 50) return "ATH ëŒ€ë¹„ " + d + "% â€” ë°˜í† ë§‰ ìˆ˜ì¤€, ê°•ë ¥í•œ ë§¤ìˆ˜ êµ¬ê°„";
      if (pct >= 30) return "ATH ëŒ€ë¹„ " + d + "% â€” í° ì¡°ì •, ë§¤ìˆ˜ ì ê·¹ ê²€í†  êµ¬ê°„";
      if (pct >= 20) return "ATH ëŒ€ë¹„ " + d + "% â€” ì¤‘ê°„ ì¡°ì •, ë§¤ìˆ˜ ê³ ë ¤ ê°€ëŠ¥";
      if (pct >= 10) return "ATH ëŒ€ë¹„ " + d + "% â€” ì†Œí­ ì¡°ì •, ì¶©ë¶„í•œ í•˜ë½ ì•„ë‹˜";
      return "ATH ëŒ€ë¹„ " + d + "% â€” ê³ ì  ê·¼ì²˜, ë§¤ìˆ˜ ì£¼ì˜";
    }
  }
  function fundDesc(score, buy, pe, roe, peg, fcf) {
    if (score == null) return "ETF â€” í€ë”ë©˜íƒˆ í‰ê°€ ì œì™¸ (Fear + ë‚™í­ë§Œ ì ìš©)";
    var parts = [];
    if (buy != null)  parts.push("Buyë¹„ìœ¨ " + buy + "%" + (buy >= 70 ? " âœ“" : ""));
    if (pe  != null)  parts.push("Forward PE " + pe + (pe < 20 ? " âœ“" : pe > 30 ? " âœ—" : ""));
    if (roe != null)  parts.push("ROE " + roe + "%" + (roe >= 15 ? " âœ“" : ""));
    if (peg != null)  parts.push("PEG " + peg + (peg < 1 ? " âœ“ì €í‰ê°€" : peg > 2 ? " âœ—ê³ í‰ê°€" : ""));
    if (fcf)          parts.push("FCF " + fcf + (fcf === "ì–‘í˜¸" ? " âœ“" : " âœ—"));
    return parts.length ? parts.join(" &nbsp;|&nbsp; ") : "ë°ì´í„° ë¶€ì¡±";
  }
  function recessionDesc(penalty) {
    if (penalty >= 25) return "ì¥ë‹¨ê¸° ê¸ˆë¦¬ì°¨ ì‹¬ê° ì—­ì „ â€” ê²½ê¸°ì¹¨ì²´ ê°•í•œ ê²½ê³  ì‹ í˜¸ (-25ì  ë°˜ì˜)";
    if (penalty >= 15) return "ì¥ë‹¨ê¸° ê¸ˆë¦¬ì°¨ ì—­ì „ â€” ì¹¨ì²´ ì„ í–‰ì§€í‘œ ë°œë™ (-15ì  ë°˜ì˜)";
    if (penalty >= 5)  return "ì¥ë‹¨ê¸° ê¸ˆë¦¬ì°¨ í”Œë«í™” â€” ê²½ê¸° ë‘”í™” ì£¼ì˜ (-5ì  ë°˜ì˜)";
    return "ì¥ë‹¨ê¸° ê¸ˆë¦¬ì°¨ ì •ìƒ â€” ì¹¨ì²´ íŒ¨ë„í‹° ì—†ìŒ";
  }
  function m2Desc(adj) {
    if (adj >= 10) return "M2 í†µí™”ëŸ‰ ê¸‰ì¦(YoY 15%â†‘) â€” ìœ ë™ì„± ê³¼ì‰, ìœ„í—˜ìì‚° ê°•ë ¥ ë§¤ìˆ˜ ì‹ í˜¸ (+10ì  ë°˜ì˜)";
    if (adj >= 5)  return "M2 í†µí™”ëŸ‰ í™•ì¥(YoY 7~15%) â€” ìœ ë™ì„± í’ë¶€, ë§¤ìˆ˜ ìš°í˜¸ í™˜ê²½ (+5ì  ë°˜ì˜)";
    if (adj >= 0)  return "M2 í†µí™”ëŸ‰ ì¤‘ë¦½/ê±´ê°•í•œ ì„±ì¥(YoY 0~7%) â€” ìœ ë™ì„± ì•ˆì •, ì¡°ì • ì—†ìŒ";
    if (adj >= -7) return "M2 í†µí™”ëŸ‰ ìˆ˜ì¶•(YoY 0~-2%) â€” ìœ ë™ì„± ê°ì†Œ êµ¬ê°„, ì¦ì‹œ ë¶€ë‹´ (-7ì  ë°˜ì˜)";
    return "M2 í†µí™”ëŸ‰ ì‹¬ê° ìˆ˜ì¶•(YoY -2%â†“) â€” ìœ ë™ì„± ê¸‰ê²©íˆ ì¤„ì–´ ì¦ì‹œ í•˜ë½ ì••ë ¥ ê°•í•¨ (-15ì  ë°˜ì˜)";
  }
  function gradeDesc(g, isEtf) {
    if (g.includes("ê°•ë ¥")) return isEtf
      ? "ì‹œì¥ ê³µí¬ + ETF ëŒ€í˜• ë‚™í­ì´ ë™ì‹œì— ì¶©ì¡±ëœ ìµœì  ë§¤ìˆ˜ íƒ€ì´ë°ì…ë‹ˆë‹¤. ë¶„í•  ë§¤ìˆ˜ë¥¼ ì ê·¹ ê³ ë ¤í•˜ì„¸ìš”."
      : "ì‹œì¥ ê³µí¬ + í° ë‚™í­ + ìš°ìˆ˜í•œ í€ë”ë©˜íƒˆì´ ë™ì‹œì— ì¶©ì¡±ëœ ìµœì  ë§¤ìˆ˜ íƒ€ì´ë°ì…ë‹ˆë‹¤. ë¶„í•  ë§¤ìˆ˜ë¥¼ ì ê·¹ ê³ ë ¤í•˜ì„¸ìš”.";
    if (g.includes("ë§¤ìˆ˜ ê³ ë ¤")) return isEtf
      ? "ì‹œì¥ ê³µí¬ì™€ ETF ë‚™í­ ì¡°ê±´ì´ ì¶©ì¡±ëœ ë§¤ìˆ˜ ê³ ë ¤ êµ¬ê°„ì…ë‹ˆë‹¤. ì†ŒëŸ‰ë¶€í„° ë¶„í•  ì ‘ê·¼ì„ ê¶Œì¥í•©ë‹ˆë‹¤."
      : "ì¼ë¶€ ì¡°ê±´ì´ ì¶©ì¡±ëœ ë§¤ìˆ˜ ê³ ë ¤ êµ¬ê°„ì…ë‹ˆë‹¤. ì¶”ê°€ í•˜ë½ ê°€ëŠ¥ì„±ì„ ê³ ë ¤í•´ ì†ŒëŸ‰ë¶€í„° ë¶„í•  ì ‘ê·¼ì„ ê¶Œì¥í•©ë‹ˆë‹¤.";
    if (g.includes("ê´€ë§")) return "ë§¤ìˆ˜ ì¡°ê±´ì´ ë¶€ë¶„ì ìœ¼ë¡œë§Œ ì¶©ì¡±ë©ë‹ˆë‹¤. ì‹œì¥ ìƒí™©ì„ ë” ì§€ì¼œë³´ê±°ë‚˜ í•˜ë½ ì‹œ ì¤€ë¹„í•˜ëŠ” ë‹¨ê³„ì…ë‹ˆë‹¤.";
    return "í˜„ì¬ ë§¤ìˆ˜ ì¡°ê±´ì´ ë¶ˆì¶©ë¶„í•©ë‹ˆë‹¤. ì‹œì¥ ì•ˆì • ë˜ëŠ” ê°€ê²© ì¡°ì •ì„ ê¸°ë‹¤ë¦¬ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.";
  }

  /* ì ìˆ˜ ì§„í–‰ë°” HTML */
  function progressBar(score, max, color) {
    var pct = max > 0 ? Math.round(score / max * 100) : 0;
    return '<div class="progress" style="height:10px"><div class="progress-bar" style="width:' +
      pct + '%;background:' + color + '">' + score + '/' + max + '</div></div>';
  }

  /* â”€â”€ ëª¨ë‹¬ ë³¸ë¬¸ êµ¬ì„± â”€â”€ */
  var baseScore = total + recession - m2Adj;  /* ì¡°ì • ì „ ì›ì ìˆ˜ (ë³´ë„ˆìŠ¤ëŠ” ë¹¼ê³ , íŒ¨ë„í‹°ëŠ” ë”í•´ì„œ í™˜ì›) */
  var html = '';

  /* ì¢…í•© ì ìˆ˜ */
  html += '<div class="mb-4">';
  html += '<div class="d-flex align-items-center gap-3 mb-2">';
  html += '<div class="text-center" style="min-width:80px">';
  html += '<div class="display-4 fw-bold" style="color:' + gradeColor + '">' + total + '</div>';
  html += '<div class="small text-muted">/ 100ì </div></div>';
  html += '<div class="flex-grow-1">';
  html += progressBar(total, 100, gradeColor);
  html += '<div class="mt-2 small">' + gradeDesc(grade, isEtf) + '</div>';
  html += '</div></div>';
  if (recession > 0 || m2Adj !== 0) {
    var adjParts = [];
    if (recession > 0) adjParts.push("ì¹¨ì²´ -" + recession + "ì ");
    if (m2Adj > 0)     adjParts.push('<span class="text-success fw-bold">M2 ìœ ë™ì„± +' + m2Adj + 'ì </span>');
    if (m2Adj < 0)     adjParts.push("M2ìˆ˜ì¶• " + m2Adj + "ì ");
    var alertCls = (recession > 0 || m2Adj < 0) ? "warning" : "success";
    var alertIcon = (m2Adj > 0 && recession === 0) ? "ğŸ’§" : "âš ";
    html += '<div class="alert alert-' + alertCls + ' py-1 small mb-0">' + alertIcon + ' ì ìˆ˜ ì¡°ì •: ' +
      adjParts.join(", ") + ' (ì›ì ìˆ˜: ' + baseScore + 'ì )</div>';
  }
  html += '</div>';

  /* ì ìˆ˜ êµ¬ì„± 3ê°œ ì¹´ë“œ */
  html += '<div class="row g-3 mb-3">';

  /* ì‹œì¥ ê³µí¬ ì ìˆ˜ */
  html += '<div class="col-md-4"><div class="card p-3 h-100 border-danger border-opacity-25">';
  html += '<div class="small fw-bold text-danger mb-1">ğŸ”´ ì‹œì¥ ê³µí¬ ì ìˆ˜ &nbsp;' + fear + '/100</div>';
  html += progressBar(fear, 100, "#e74c3c");
  html += '<div class="small text-muted mt-2">' + fearDesc(fear) + '</div>';
  html += '</div></div>';

  /* ë‚™í­ ì ìˆ˜ */
  html += '<div class="col-md-4"><div class="card p-3 h-100 border-warning border-opacity-25">';
  html += '<div class="small fw-bold text-warning mb-1">ğŸŸ  ë‚™í­ ì ìˆ˜ &nbsp;' + ddScore + '/100</div>';
  html += progressBar(ddScore, 100, "#f39c12");
  html += '<div class="small text-muted mt-2">' + ddDesc(athDd, isEtf) + '</div>';
  html += '</div></div>';

  /* í€ë”ë©˜íƒˆ ì ìˆ˜ */
  html += '<div class="col-md-4"><div class="card p-3 h-100 border-success border-opacity-25">';
  html += '<div class="small fw-bold text-success mb-1">ğŸŸ¢ í€ë”ë©˜íƒˆ ' +
    (fundScore != null ? fundScore + '/100' : 'ETF') + '</div>';
  if (fundScore != null) progressBar(fundScore, 100, "#27ae60");
  html += '<div class="small text-muted mt-2">' + fundDesc(fundScore, buyRatio, fpe, roe, peg, fcf) + '</div>';
  html += '</div></div>';

  html += '</div>';

  /* ì¹¨ì²´ ë¦¬ìŠ¤í¬ + ìœ ë™ì„± ë¦¬ìŠ¤í¬ (2ì—´ ì¹´ë“œ) */
  html += '<div class="row g-3 mb-3">';

  /* ê²½ê¸°ì¹¨ì²´ ë¦¬ìŠ¤í¬ */
  html += '<div class="col-md-6"><div class="card p-3 h-100 border-' +
    (recession >= 25 ? "danger" : recession >= 15 ? "warning" : recession >= 5 ? "info" : "success") +
    ' border-opacity-25">';
  html += '<div class="small fw-bold mb-1">ğŸ“‰ ê²½ê¸°ì¹¨ì²´ ë¦¬ìŠ¤í¬</div>';
  html += '<div class="small text-muted">' + recessionDesc(recession) + '</div>';
  html += '</div></div>';

  /* ìœ ë™ì„±(M2) í˜„í™© â€” ë³´ë„ˆìŠ¤/íŒ¨ë„í‹° ì–‘ë°©í–¥ */
  html += '<div class="col-md-6"><div class="card p-3 h-100 border-' +
    (m2Adj <= -15 ? "danger" : m2Adj <= -7 ? "warning" : m2Adj >= 5 ? "success" : "secondary") +
    ' border-opacity-25">';
  html += '<div class="small fw-bold mb-1">ğŸ’§ ìœ ë™ì„±(M2) ' + (m2Adj > 0 ? 'ë³´ë„ˆìŠ¤' : 'í˜„í™©') + '</div>';
  html += '<div class="small text-muted">' + m2Desc(m2Adj) + '</div>';
  html += '</div></div>';

  html += '</div>';

  /* ì ìˆ˜ ê³„ì‚°ì‹ */
  html += '<div class="card bg-light p-3 small">';
  html += '<div class="fw-bold mb-1">ğŸ“ ì ìˆ˜ ê³„ì‚°ì‹</div>';
  if (isEtf) {
    html += '<code>' + fear + ' Ã— 0.5 + ' + ddScore + ' Ã— 0.5 = ' + (baseScore) + 'ì </code>';
    html += ' (ETF: ê³µí¬Â·ë‚™í­ë§Œ ì ìš©)';
  } else {
    html += '<code>' + fear + ' Ã— 0.3 + ' + ddScore + ' Ã— 0.4 + ' +
      (fundScore || 0) + ' Ã— 0.3 = ' + baseScore + 'ì </code>';
    html += ' (ì£¼ì‹: ê³µí¬Â·ë‚™í­Â·í€ë”ë©˜íƒˆ)';
  }
  if (recession > 0 || m2Adj !== 0) {
    if (recession > 0) html += ' &nbsp;- <span class="text-danger">' + recession + 'ì (ì¹¨ì²´)</span>';
    if (m2Adj > 0)     html += ' &nbsp;+ <span class="text-success">' + m2Adj + 'ì (M2ë³´ë„ˆìŠ¤)</span>';
    if (m2Adj < 0)     html += ' &nbsp;- <span class="text-warning">' + Math.abs(m2Adj) + 'ì (M2ìˆ˜ì¶•)</span>';
    html += ' = <strong>' + total + 'ì </strong>';
  }
  html += '</div>';

  document.getElementById("modalBody").innerHTML = html;

  /* ëª¨ë‹¬ ì§ì ‘ ì—´ê¸° */
  var modalEl = document.getElementById("gradeModal");
  var modal = bootstrap.Modal.getOrCreateInstance(modalEl);
  modal.show();
});
</script>
<style>
/* ê°€ê²© ê°±ì‹  ì‹œ í”Œë˜ì‹œ ì• ë‹ˆë©”ì´ì…˜ */
@keyframes flashGreen {
  0%   { background-color: rgba(40,167,69,0.4); }
  100% { background-color: transparent; }
}
@keyframes flashRed {
  0%   { background-color: rgba(220,53,69,0.4); }
  100% { background-color: transparent; }
}
.flash-up   { animation: flashGreen 1.2s ease-out; }
.flash-down { animation: flashRed   1.2s ease-out; }
</style>

<script>
(function () {
  /* â”€â”€ ì„¤ì • â”€â”€ */
  var PRICE_INTERVAL  = 10;   // í˜„ì¬ê°€ AJAX ê°±ì‹  ì£¼ê¸° (ì´ˆ)
  var PAGE_INTERVAL   = 300;  // ì „ì²´ í˜ì´ì§€ ê°±ì‹  ì£¼ê¸° (ì´ˆ, ì‹œì¥ì‹¬ë¦¬ì§€í‘œ ê°±ì‹ ìš©)

  var priceRemaining = PRICE_INTERVAL;
  var pageRemaining  = PAGE_INTERVAL;

  var badge       = document.getElementById("autoRefreshBadge");
  var countdown   = document.getElementById("countdown");
  var priceBadge  = document.getElementById("priceUpdateBadge");
  var lastUpdated = document.getElementById("lastUpdatedText");

  if (badge) badge.style.display = "inline-block";

  /* í˜„ì¬ ì‹œê° ë¬¸ìì—´ */
  function nowStr() { return new Date().toLocaleTimeString("ko-KR"); }

  /* í˜ì´ì§€ ìµœì´ˆ ì§„ì… ì‹œ ì¦‰ì‹œ ê°€ê²© ê°±ì‹  */
  fetchPrices();

  /* â”€â”€ 1ì´ˆ ë©”ì¸ íƒ€ì´ë¨¸ â”€â”€ */
  setInterval(function () {
    priceRemaining--;
    pageRemaining--;

    /* ë„¤ë¹„ë°” ì¹´ìš´íŠ¸ë‹¤ìš´: ì „ì²´ í˜ì´ì§€ ê°±ì‹  ê¸°ì¤€ */
    if (countdown) countdown.textContent = pageRemaining;
    if (badge) {
      badge.className = pageRemaining <= 30
        ? "badge bg-warning text-dark"
        : "badge bg-secondary";
    }

    /* 10ì´ˆë§ˆë‹¤ í˜„ì¬ê°€ AJAX ê°±ì‹  */
    if (priceRemaining <= 0) {
      priceRemaining = PRICE_INTERVAL;
      fetchPrices();
    }

    /* 5ë¶„ë§ˆë‹¤ ì „ì²´ í˜ì´ì§€ ì¬ë¡œë“œ (ì‹œì¥ì‹¬ë¦¬ì§€í‘œ ê°±ì‹ ) */
    if (pageRemaining <= 0) {
      location.reload();
    }
  }, 1000);

  /* â”€â”€ ì ìˆ˜ ê³„ì‚° í—¬í¼ í•¨ìˆ˜ (Python scoring.py ì™€ ë™ì¼ ë¡œì§) â”€â”€ */

  /* ATH ë‚™í­ â†’ ë‚™í­ì ìˆ˜ (0~100) â€” ì¼ë°˜ ì£¼ì‹ìš© (10~50% êµ¬ê°„) */
  function calcDrawdownScore(athDrawdownPct) {
    if (athDrawdownPct === null || isNaN(athDrawdownPct)) return 0;
    var d = Math.abs(athDrawdownPct);
    if (d >= 50) return 100;
    if (d >= 30) return 75;
    if (d >= 20) return 50;
    if (d >= 10) return 25;
    return 0;
  }

  /* ATH ë‚™í­ â†’ ë‚™í­ì ìˆ˜ (0~100) â€” ETF ì „ìš© (5~20% êµ¬ê°„, ì§€ìˆ˜ì¶”ì¢… íŠ¹ì„± ë°˜ì˜) */
  function calcEtfDrawdownScore(athDrawdownPct) {
    if (athDrawdownPct === null || isNaN(athDrawdownPct)) return 0;
    var d = Math.abs(athDrawdownPct);
    if (d >= 20) return 100;
    if (d >= 15) return 75;
    if (d >= 10) return 50;
    if (d >= 5)  return 25;
    return 0;
  }

  /* ìµœì¢… ì¶”ì²œì ìˆ˜ ê³„ì‚° */
  function calcTotalScore(fearScore, drawdownScore, fundamentalScore, isEtf, recessionPenalty) {
    var total;
    if (isEtf) {
      total = Math.round(fearScore * 0.5 + drawdownScore * 0.5);
    } else {
      total = Math.round(fearScore * 0.3 + drawdownScore * 0.4 + (fundamentalScore || 0) * 0.3);
    }
    return Math.max(0, total - (recessionPenalty || 0));
  }

  /* ì ìˆ˜ â†’ ë“±ê¸‰ëª… + ìƒ‰ìƒ */
  function getGradeInfo(total) {
    if (total >= 70) return { grade: "â˜… ê°•ë ¥ ë§¤ìˆ˜", color: "#27ae60" };
    if (total >= 50) return { grade: "ë§¤ìˆ˜ ê³ ë ¤",   color: "#2ecc71" };
    if (total >= 30) return { grade: "ê´€ë§",         color: "#f39c12" };
    return             { grade: "ë§¤ìˆ˜ ë³´ë¥˜",         color: "#95a5a6" };
  }

  /* â”€â”€ í˜„ì¬ê°€ AJAX ê°±ì‹  í•¨ìˆ˜ â”€â”€ */
  function fetchPrices() {
    fetch("/api/prices")
      .then(function(r) { return r.json(); })
      .then(function(data) { updatePrices(data); })
      .catch(function() {
        if (priceBadge) priceBadge.textContent = "âš  ê°€ê²© ì¡°íšŒ ì‹¤íŒ¨";
      });
  }

  /* â”€â”€ í…Œì´ë¸” ê°€ê²©Â·ë‚™í­Â·ì ìˆ˜Â·ë“±ê¸‰ ì—…ë°ì´íŠ¸ â”€â”€ */
  function updatePrices(data) {
    var updatedCount = 0;

    Object.keys(data).forEach(function(ticker) {
      var item = data[ticker];
      if (!item || !item.price) return;

      var newPrice  = item.price;
      var changePct = item.change_pct;

      /* â‘  í˜„ì¬ê°€ ì…€ ì—…ë°ì´íŠ¸ */
      var priceEl = document.querySelector(".price-cell[data-ticker='" + ticker + "']");
      if (priceEl) {
        var oldPrice = parseFloat(priceEl.dataset.price || 0);

        if (Math.abs(newPrice - oldPrice) >= 0.01) {
          priceEl.dataset.price = newPrice;
          priceEl.textContent = "$" + newPrice.toFixed(2);

          priceEl.classList.remove("flash-up", "flash-down");
          void priceEl.offsetWidth; /* reflow ê°•ì œ (ì• ë‹ˆë©”ì´ì…˜ ì¬ì‹œì‘) */
          priceEl.classList.add(newPrice > oldPrice ? "flash-up" : "flash-down");
          updatedCount++;
        }

        /* ì „ì¼ ëŒ€ë¹„ ë³€ë™ë¥  í‘œì‹œ */
        var changeEl = document.querySelector(".change-cell[data-ticker='" + ticker + "']");
        if (changeEl && changePct !== null && changePct !== undefined) {
          var sign  = changePct >= 0 ? "+" : "";
          var color = changePct >= 0 ? "text-success" : "text-danger";
          changeEl.className = "change-cell small " + color;
          changeEl.textContent = "(" + sign + changePct + "%)";
        }
      }

      /* â‘¡ ATH ë‚™í­ ì¬ê³„ì‚° ë° ì…€ ì—…ë°ì´íŠ¸ */
      var drawdownEl = document.querySelector(".drawdown-cell[data-ticker='" + ticker + "']");
      if (drawdownEl) {
        var ath = parseFloat(drawdownEl.dataset.ath || 0);
        if (ath > 0) {
          /* (í˜„ì¬ê°€ - ATH) / ATH Ã— 100, ì†Œìˆ˜ì  1ìë¦¬ */
          var oldDrawdownPct = parseFloat(drawdownEl.dataset.drawdown || 0); /* ì´ì „ê°’ ë¨¼ì € ì €ì¥ */
          var newDrawdownPct = Math.round((newPrice - ath) / ath * 1000) / 10;
          drawdownEl.dataset.drawdown = newDrawdownPct;                       /* dataset ê°±ì‹  */

          /* ìƒ‰ìƒ í´ë˜ìŠ¤ ê°±ì‹  */
          drawdownEl.className = "drawdown-cell";
          if      (newDrawdownPct <= -30) drawdownEl.classList.add("text-danger", "fw-bold");
          else if (newDrawdownPct <= -15) drawdownEl.classList.add("text-warning");
          else                            drawdownEl.classList.add("text-muted");

          /* ë‚™í­ í”Œë˜ì‹œ ì• ë‹ˆë©”ì´ì…˜ (ì”ì—¬ í´ë˜ìŠ¤ í•­ìƒ ë¨¼ì € ì œê±°) */
          drawdownEl.classList.remove("flash-up", "flash-down");
          drawdownEl.textContent = newDrawdownPct + "%";
          if (Math.abs(newDrawdownPct - oldDrawdownPct) >= 0.1) {
            void drawdownEl.offsetWidth;
            drawdownEl.classList.add(newDrawdownPct > oldDrawdownPct ? "flash-up" : "flash-down");
          }

          /* â‘¢ ë‚™í­ì ìˆ˜Â·ì¶”ì²œì ìˆ˜Â·ë“±ê¸‰ ì¬ê³„ì‚° */
          var badgeEl = document.querySelector(".grade-badge[data-ticker='" + ticker + "']");
          if (badgeEl) {
            var fearScore       = parseFloat(badgeEl.dataset.fear       || 0);
            var fundamentalScore = badgeEl.dataset.fundamental !== ""
                                  ? parseFloat(badgeEl.dataset.fundamental)
                                  : null;
            var recessionPenalty = parseFloat(badgeEl.dataset.recession || 0);
            var isEtf            = badgeEl.dataset.isEtf === "true";

            /* ETFëŠ” ETF ì „ìš© ë‚™í­ ê¸°ì¤€(5~20%) ì‚¬ìš©, ì£¼ì‹ì€ ì¼ë°˜ ê¸°ì¤€(10~50%) ì‚¬ìš© */
            var newDrawdownScore = isEtf ? calcEtfDrawdownScore(newDrawdownPct)
                                         : calcDrawdownScore(newDrawdownPct);
            var newTotal         = calcTotalScore(fearScore, newDrawdownScore,
                                                  fundamentalScore, isEtf, recessionPenalty);
            var gradeInfo        = getGradeInfo(newTotal);

            /* ë“±ê¸‰ ë°°ì§€ ê°±ì‹  */
            badgeEl.textContent           = gradeInfo.grade;
            badgeEl.style.background      = gradeInfo.color;
            badgeEl.dataset.total         = newTotal;
            badgeEl.dataset.grade         = gradeInfo.grade;
            badgeEl.dataset.gradeColor    = gradeInfo.color;
            badgeEl.dataset.drawdownScore = newDrawdownScore;
            badgeEl.dataset.athDrawdown   = newDrawdownPct;

            /* ì¶”ì²œì ìˆ˜ ì…€ ê°±ì‹  + í”Œë˜ì‹œ ì• ë‹ˆë©”ì´ì…˜ */
            var scoreEl = document.querySelector(".score-cell[data-ticker='" + ticker + "']");
            if (scoreEl) {
              var oldTotal = parseInt(scoreEl.dataset.score || 0, 10);
              /* ì¬ì •ë ¬(appendChild) ì‹œ ì”ì—¬ í´ë˜ìŠ¤ë¡œ ì• ë‹ˆë©”ì´ì…˜ ì¬ì‹¤í–‰ ë°©ì§€: í•­ìƒ ë¨¼ì € ì œê±° */
              scoreEl.classList.remove("flash-up", "flash-down");
              if (newTotal !== oldTotal) {
                scoreEl.dataset.score = newTotal;
                scoreEl.textContent   = newTotal;
                void scoreEl.offsetWidth; /* reflow ê°•ì œ í›„ ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€ */
                scoreEl.classList.add(newTotal > oldTotal ? "flash-up" : "flash-down");
              }
            }
          }
        }
      }
    });

    /* â‘£ ì ìˆ˜ ê¸°ì¤€ í–‰ ì¬ì •ë ¬ + ìˆœìœ„ ë²ˆí˜¸ ê°±ì‹  */
    var tbody = document.querySelector("table tbody");
    if (tbody) {
      var rows = Array.from(tbody.querySelectorAll("tr[data-ticker]"));
      rows.sort(function(a, b) {
        var sA = parseInt(a.querySelector(".score-cell") && a.querySelector(".score-cell").textContent || 0, 10);
        var sB = parseInt(b.querySelector(".score-cell") && b.querySelector(".score-cell").textContent || 0, 10);
        return sB - sA;  /* ë‚´ë¦¼ì°¨ìˆœ */
      });
      rows.forEach(function(row, idx) {
        tbody.appendChild(row);  /* ì¬ì •ë ¬ */
        var rankCell = row.querySelector(".rank-cell");
        if (rankCell) rankCell.textContent = idx + 1;
      });
    }

    /* ê°±ì‹  ë°°ì§€ ì—…ë°ì´íŠ¸ */
    if (priceBadge) {
      if (updatedCount > 0) {
        priceBadge.className = "badge bg-success";
        priceBadge.textContent = "âœ“ " + nowStr() + " ê°±ì‹  (" + updatedCount + "ì¢…ëª©)";
      } else {
        priceBadge.className = "badge bg-secondary";
        priceBadge.textContent = "âœ“ " + nowStr() + " í™•ì¸ (ë³€ë™ì—†ìŒ)";
      }
    }

    if (lastUpdated) {
      lastUpdated.textContent = "ë§ˆì§€ë§‰ ê°±ì‹ : " + nowStr();
    }
  }

  /* â”€â”€ íƒ­ ë³µê·€ ì‹œ ì¦‰ì‹œ ê°€ê²© ê°±ì‹  â”€â”€ */
  document.addEventListener("visibilitychange", function () {
    if (!document.hidden) fetchPrices();
  });
})();
</script>
{% endblock %}
