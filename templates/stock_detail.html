{% extends "base.html" %}
{% block title %}{{ stock.ticker }} ìƒì„¸ â€” ë¯¸êµ­ì£¼ì‹ ì¶”ì²œ{% endblock %}

{% block content %}

<div class="mb-3">
  <a href="/" class="btn btn-outline-secondary btn-sm">â† ëŒ€ì‹œë³´ë“œ</a>
</div>

{% if stock.error %}
  <div class="alert alert-danger">{{ stock.ticker }} ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {{ stock.error }}</div>
{% else %}

<!-- í—¤ë” -->
<div class="d-flex align-items-baseline gap-3 mb-3 flex-wrap">
  <h3 class="mb-0">{{ stock.ticker }}</h3>
  <span class="text-muted">{{ stock.name }}</span>
  <!-- í˜„ì¬ê°€: AJAXë¡œ 10ì´ˆë§ˆë‹¤ ê°±ì‹  -->
  <span id="detailPrice" class="fs-4 fw-bold"
    data-ticker="{{ stock.ticker }}"
    data-price="{{ stock.current_price }}">
    ${{ "%.2f"|format(stock.current_price) }}
  </span>
  <!-- ì „ì¼ ëŒ€ë¹„ ë³€ë™ë¥  (AJAXê°€ ì±„ì›Œì¤Œ) -->
  <span id="detailChange" class="small"></span>
  {% if stock.sector %}
    <span class="badge bg-secondary">{{ stock.sector }}</span>
  {% endif %}
  <span id="detailUpdatedAt" class="text-muted small"></span>
</div>

<!-- ì¶”ì²œ ì ìˆ˜ ì¹´ë“œ -->
<div class="card mb-4 p-3 border-2" style="border-color:{{ score.grade_color }}!important">
  <div class="row align-items-center g-3">
    <div class="col-auto text-center">
      <div class="text-muted small">ì¢…í•© ì¶”ì²œ ì ìˆ˜</div>
      <div class="display-4 fw-bold" style="color:{{ score.grade_color }}">{{ score.total_score }}</div>
      <span class="badge fs-6 grade-badge"
        style="background:{{ score.grade_color }}; cursor:pointer"
        data-ticker="{{ stock.ticker }}"
        data-name="{{ stock.name }}"
        data-total="{{ score.total_score }}"
        data-grade="{{ score.grade }}"
        data-grade-color="{{ score.grade_color }}"
        data-fear="{{ score.fear_score }}"
        data-drawdown-score="{{ score.drawdown_score }}"
        data-fundamental="{{ score.fundamental_score if score.fundamental_score is not none else '' }}"
        data-recession="{{ score.recession_penalty if score.recession_penalty is defined else 0 }}"
        data-m2-adj="{{ score.m2_adjustment if score.m2_adjustment is defined else 0 }}"
        data-technical="{{ score.technical_score if score.technical_score is defined else 0 }}"
        data-rsi="{{ stock.rsi if (stock.rsi is defined and stock.rsi is not none) else '' }}"
        data-macd-bullish="{{ 'true' if stock.macd_bullish else 'false' }}"
        data-ma-signal="{{ stock.ma_signal if (stock.ma_signal is defined and stock.ma_signal) else 'neutral' }}"
        data-ath-drawdown="{{ stock.ath_drawdown_pct }}"
        data-buy-ratio="{{ stock.buy_ratio_pct if stock.buy_ratio_pct is not none else '' }}"
        data-forward-pe="{{ stock.forward_pe if stock.forward_pe is not none else '' }}"
        data-roe="{{ stock.roe if (stock.roe is defined and stock.roe is not none) else '' }}"
        data-peg="{{ stock.peg if (stock.peg is defined and stock.peg is not none) else '' }}"
        data-fcf="{{ 'ì–‘í˜¸' if stock.fcf_positive else 'ë¶€ì¡±' }}"
        data-is-etf="{{ 'true' if stock.is_etf else 'false' }}"
        data-reason="{{ score.reason }}">
        {{ score.grade }}
      </span>
    </div>
    <div class="col">
      <div class="mb-2 text-muted small">ê·¼ê±°: {{ score.reason }}</div>
      <div class="row g-2">
        <div class="col-3 text-center">
          <div class="small text-muted">ê³µí¬ ì ìˆ˜</div>
          <div class="fw-bold">{{ score.fear_score }}/100</div>
          <div class="progress mt-1" style="height:6px">
            <div class="progress-bar bg-danger" style="width:{{ score.fear_score }}%"></div>
          </div>
        </div>
        <div class="col-3 text-center">
          <div class="small text-muted">ë‚™í­ ì ìˆ˜</div>
          <div class="fw-bold">{{ score.drawdown_score }}/100</div>
          <div class="progress mt-1" style="height:6px">
            <div class="progress-bar bg-warning" style="width:{{ score.drawdown_score }}%"></div>
          </div>
        </div>
        <div class="col-3 text-center">
          <div class="small text-muted">í€ë”ë©˜íƒˆ</div>
          <div class="fw-bold">{{ score.fundamental_score if score.fundamental_score is not none else 'ETF' }}/100</div>
          <div class="progress mt-1" style="height:6px">
            <div class="progress-bar bg-success" style="width:{{ score.fundamental_score if score.fundamental_score is not none else 0 }}%"></div>
          </div>
        </div>
        <div class="col-3 text-center">
          <div class="small text-muted">ê¸°ìˆ ì  ë¶„ì„</div>
          <div class="fw-bold">{{ score.technical_score }}/100</div>
          <div class="progress mt-1" style="height:6px">
            <div class="progress-bar bg-info" style="width:{{ score.technical_score }}%"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ì°¨íŠ¸ + ë‚™í­ -->
<div class="row g-3 mb-4">
  <div class="col-md-8">
    <div class="card p-3 h-100">
      <!-- ì´ë™í‰ê·  ë²”ë¡€ -->
      <div class="d-flex align-items-center gap-3 mb-2 flex-wrap">
        <span class="small text-muted">1ë…„ ì£¼ê°€ ì¶”ì´</span>
        <span class="small"><span style="color:#3498db">â”</span> ì¢…ê°€</span>
        <span class="small"><span style="color:#e67e22">â”</span> MA20</span>
        <span class="small"><span style="color:#9b59b6">â”</span> MA60</span>
        <span class="small"><span style="color:#e74c3c">â”</span> MA120</span>
      </div>
      <!-- ì£¼ê°€ + ì´ë™í‰ê·  ì°¨íŠ¸ -->
      <canvas id="priceChart" style="max-height:240px"></canvas>
      <!-- ê±°ë˜ëŸ‰ ì°¨íŠ¸ -->
      <div class="small text-muted mt-3 mb-1">ê±°ë˜ëŸ‰</div>
      <canvas id="volumeChart" style="max-height:80px"></canvas>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card p-3 h-100">
      <div class="small text-muted mb-2">ê³ ì  ëŒ€ë¹„ ë‚™í­</div>
      <table class="table table-sm">
        <tr>
          <td class="text-muted">í˜„ì¬ê°€</td>
          <td class="fw-bold">${{ "%.2f"|format(stock.current_price) }}</td>
        </tr>
        <tr>
          <td class="text-muted">ì—­ëŒ€ ìµœê³ ê°€(ATH)</td>
          <td>${{ "%.2f"|format(stock.ath) }} <span class="text-muted small">({{ stock.ath_date }})</span></td>
        </tr>
        <tr>
          <td class="text-muted">ATH ëŒ€ë¹„ ë‚™í­</td>
          <td class="fw-bold {% if stock.ath_drawdown_pct <= -30 %}text-danger{% elif stock.ath_drawdown_pct <= -15 %}text-warning{% endif %}">
            {{ stock.ath_drawdown_pct }}%
          </td>
        </tr>
        <tr>
          <td class="text-muted">52ì£¼ ìµœê³ ê°€</td>
          <td>${{ "%.2f"|format(stock.high_52w) }}</td>
        </tr>
        <tr>
          <td class="text-muted">52ì£¼ ê³ ì  ëŒ€ë¹„</td>
          <td class="{% if stock.high_52w_drawdown_pct <= -15 %}text-warning{% endif %}">
            {{ stock.high_52w_drawdown_pct }}%
          </td>
        </tr>
      </table>
    </div>
  </div>
</div>

<!-- í€ë”ë©˜íƒˆ + ì• ë„ë¦¬ìŠ¤íŠ¸ -->
<div class="row g-3 mb-4">
  <div class="col-md-5">
    <div class="card p-3 h-100">
      {% if stock.is_etf %}
        <div class="small text-muted mb-2">ETF ì§€í‘œ <span class="badge bg-info text-dark ms-1">ETF</span></div>
        <table class="table table-sm">
          <tr>
            <td class="text-muted">Trailing PER</td>
            <td>{{ stock.trailing_pe if stock.trailing_pe else 'N/A' }}</td>
          </tr>
          <tr>
            <td class="text-muted">YTD ìˆ˜ìµë¥ </td>
            <td class="{% if stock.ytd_return and stock.ytd_return > 0 %}text-success{% elif stock.ytd_return %}text-danger{% endif %}">
              {{ ('+' if stock.ytd_return and stock.ytd_return > 0 else '') + stock.ytd_return|string + '%' if stock.ytd_return is not none else 'N/A' }}
            </td>
          </tr>
          <tr>
            <td class="text-muted">3ë…„ í‰ê·  ìˆ˜ìµë¥ </td>
            <td class="{% if stock.three_year_return and stock.three_year_return > 0 %}text-success{% elif stock.three_year_return %}text-danger{% endif %}">
              {{ ('+' if stock.three_year_return and stock.three_year_return > 0 else '') + stock.three_year_return|string + '%' if stock.three_year_return is not none else 'N/A' }}
            </td>
          </tr>
          <tr>
            <td class="text-muted">ìš´ìš©ìì‚° (AUM)</td>
            <td>
              {% if stock.total_assets %}
                ${{ "%.1fB"|format(stock.total_assets / 1e9) if stock.total_assets >= 1e9 else "%.0fM"|format(stock.total_assets / 1e6) }}
              {% else %}N/A{% endif %}
            </td>
          </tr>
        </table>
        <div class="alert alert-light p-2 small mt-1 mb-0">
          ETFëŠ” í€ë”ë©˜íƒˆ ì ìˆ˜ ëŒ€ì‹  <strong>ì‹œì¥ ê³µí¬ + ë‚™í­</strong> ê¸°ì¤€ìœ¼ë¡œ ì ìˆ˜ë¥¼ ì‚°ì¶œí•©ë‹ˆë‹¤.
        </div>
      {% else %}
        <div class="small text-muted mb-2">í€ë”ë©˜íƒˆ ì§€í‘œ</div>
        <table class="table table-sm">
          <tr>
            <td class="text-muted"
              data-bs-toggle="tooltip"
              data-bs-title="í–¥í›„ 12ê°œì›” ì˜ˆìƒ ì‹¤ì  ê¸°ì¤€ ì£¼ê°€ìˆ˜ìµë¹„ìœ¨. ë‚®ì„ìˆ˜ë¡ ì €í‰ê°€. ì—…ì¢… í‰ê·  ëŒ€ë¹„ íŒë‹¨ ê¶Œì¥">
              Forward PER â„¹
            </td>
            <td class="fw-bold">{{ stock.forward_pe if stock.forward_pe else 'N/A' }}</td>
          </tr>
          <tr>
            <td class="text-muted"
              data-bs-toggle="tooltip"
              data-bs-title="ê³¼ê±° 12ê°œì›” ì‹¤ì  ê¸°ì¤€ ì£¼ê°€ìˆ˜ìµë¹„ìœ¨. Forward PERë³´ë‹¤ í˜„ì‹¤ì ì´ë‚˜ ê³¼ê±° ì§€í‘œì„">
              Trailing PER â„¹
            </td>
            <td>{{ stock.trailing_pe if stock.trailing_pe else 'N/A' }}</td>
          </tr>
          <tr>
            <td class="text-muted"
              data-bs-toggle="tooltip"
              data-bs-title="PEG = PER Ã· EPSì„±ì¥ë¥ . 1 ë¯¸ë§Œì´ë©´ ì„±ì¥ ëŒ€ë¹„ ì €í‰ê°€, 2 ì´ìƒì´ë©´ ê³ í‰ê°€ ì‹ í˜¸">
              PEG â„¹
            </td>
            {% set peg_val = stock.peg if (stock.peg is defined and stock.peg) else none %}
            <td class="{% if peg_val and peg_val < 1 %}text-success fw-bold{% elif peg_val and peg_val > 2 %}text-danger{% endif %}">
              {% if peg_val %}
                {{ peg_val }}
                {% if peg_val < 1 %}<span class="badge bg-success ms-1" style="font-size:0.65rem">ì €í‰ê°€</span>{% endif %}
              {% else %}N/A{% endif %}
            </td>
          </tr>
          <tr>
            <td class="text-muted"
              data-bs-toggle="tooltip"
              data-bs-title="ìê¸°ìë³¸ì´ìµë¥ . ìˆœì´ìµ Ã· ìê¸°ìë³¸. 15% ì´ìƒì´ë©´ ìš°ëŸ‰, ë†’ì„ìˆ˜ë¡ ìë³¸ íš¨ìœ¨ì„± ì¢‹ìŒ">
              ROE â„¹
            </td>
            {% set roe_val = stock.roe if (stock.roe is defined and stock.roe is not none) else none %}
            <td class="{% if roe_val is not none and roe_val >= 15 %}text-success{% elif roe_val is not none and roe_val < 0 %}text-danger{% endif %}">
              {{ roe_val|string + '%' if roe_val is not none else 'N/A' }}
            </td>
          </tr>
          <tr>
            <td class="text-muted"
              data-bs-toggle="tooltip"
              data-bs-title="ì£¼ë‹¹ìˆœì´ìµ ì¦ê°€ìœ¨(ì „ë…„ ë™ê¸° ëŒ€ë¹„). 10% ì´ìƒì´ë©´ ê³ ì„±ì¥, ë†’ì„ìˆ˜ë¡ ì„±ì¥ì„± ìš°ìˆ˜">
              EPS ì„±ì¥ë¥  â„¹
            </td>
            <td class="{% if stock.eps_growth_pct and stock.eps_growth_pct > 0 %}text-success{% elif stock.eps_growth_pct %}text-danger{% endif %}">
              {{ ('+' if stock.eps_growth_pct and stock.eps_growth_pct > 0 else '') + stock.eps_growth_pct|string + '%' if stock.eps_growth_pct is not none else 'N/A' }}
            </td>
          </tr>
          <tr>
            <td class="text-muted"
              data-bs-toggle="tooltip"
              data-bs-title="ì „ë…„ ëŒ€ë¹„ ë§¤ì¶œ ì¦ê°€ìœ¨. ì§€ì†ì  ë§¤ì¶œ ì„±ì¥ì´ ì£¼ê°€ ìƒìŠ¹ì˜ ê¸°ë°˜">
              ë§¤ì¶œ ì„±ì¥ë¥  â„¹
            </td>
            <td class="{% if stock.revenue_growth_pct and stock.revenue_growth_pct > 0 %}text-success{% endif %}">
              {{ ('+' if stock.revenue_growth_pct and stock.revenue_growth_pct > 0 else '') + stock.revenue_growth_pct|string + '%' if stock.revenue_growth_pct is not none else 'N/A' }}
            </td>
          </tr>
          <tr>
            <td class="text-muted"
              data-bs-toggle="tooltip"
              data-bs-title="ì‰ì—¬í˜„ê¸ˆíë¦„. ì˜ì—…í™œë™ í›„ ë‚¨ì€ í˜„ê¸ˆ. ì–‘ìˆ˜ì¼ìˆ˜ë¡ ì¬ë¬´ê±´ì „, ë°°ë‹¹Â·ìì‚¬ì£¼ë§¤ì… ì—¬ë ¥">
              FCF â„¹
            </td>
            <td class="{% if stock.fcf_positive %}text-success{% else %}text-danger{% endif %}">
              {% if stock.free_cash_flow is not none %}
                {{ '+' if stock.fcf_positive else '' }}${{ "%.1fB"|format(stock.free_cash_flow / 1e9) if stock.free_cash_flow|abs >= 1e9 else "%.0fM"|format(stock.free_cash_flow / 1e6) }}
              {% else %}N/A{% endif %}
            </td>
          </tr>
          <tr>
            <td class="text-muted"
              data-bs-toggle="tooltip"
              data-bs-title="ì£¼ê°€ë§¤ì¶œë¹„ìœ¨(Price-to-Sales). ì‹œê°€ì´ì•¡ Ã· ì—°ë§¤ì¶œ. ë‚®ì„ìˆ˜ë¡ ë§¤ì¶œ ëŒ€ë¹„ ì €í‰ê°€. ì—…ì¢…ë³„ ê¸°ì¤€ ë‹¤ë¦„">
              P/S â„¹
            </td>
            {% set ps_val = stock.price_to_sales if (stock.price_to_sales is defined and stock.price_to_sales is not none) else none %}
            <td class="{% if ps_val and ps_val < 2 %}text-success{% elif ps_val and ps_val > 10 %}text-warning{% endif %}">
              {{ ps_val if ps_val is not none else 'N/A' }}
            </td>
          </tr>
          <tr>
            <td class="text-muted"
              data-bs-toggle="tooltip"
              data-bs-title="ë¶€ì±„ë¹„ìœ¨(Debt/Equity). ì´ë¶€ì±„ Ã· ìê¸°ìë³¸. ë‚®ì„ìˆ˜ë¡ ì¬ë¬´ê±´ì „. 0.3â†“ ìš°ëŸ‰, 2â†‘ ê²½ê³„, 5â†‘ ìœ„í—˜">
              ë¶€ì±„ë¹„ìœ¨ (D/E) â„¹
            </td>
            {% set de_val = stock.debt_to_equity if (stock.debt_to_equity is defined and stock.debt_to_equity is not none) else none %}
            <td class="{% if de_val and de_val < 0.3 %}text-success fw-bold{% elif de_val and de_val > 5.0 %}text-danger fw-bold{% elif de_val and de_val > 2.0 %}text-warning{% endif %}">
              {% if de_val is not none %}
                {{ de_val }}
                {% if de_val < 0.3 %}<span class="badge bg-success ms-1" style="font-size:0.65rem">ìš°ëŸ‰</span>
                {% elif de_val > 5.0 %}<span class="badge bg-danger ms-1" style="font-size:0.65rem">ìœ„í—˜</span>
                {% elif de_val > 2.0 %}<span class="badge bg-warning text-dark ms-1" style="font-size:0.65rem">ê²½ê³„</span>{% endif %}
              {% else %}N/A{% endif %}
            </td>
          </tr>
          <tr>
            <td class="text-muted"
              data-bs-toggle="tooltip"
              data-bs-title="ìœ ë™ë¹„ìœ¨(Current Ratio). ìœ ë™ìì‚° Ã· ìœ ë™ë¶€ì±„. 2â†‘ ì•ˆì „, 1â†‘ ì–‘í˜¸, 1â†“ ìœ ë™ì„± ìœ„í—˜">
              ìœ ë™ë¹„ìœ¨ â„¹
            </td>
            {% set cr_val = stock.current_ratio if (stock.current_ratio is defined and stock.current_ratio is not none) else none %}
            <td class="{% if cr_val and cr_val > 2.0 %}text-success{% elif cr_val and cr_val < 1.0 %}text-danger{% endif %}">
              {{ cr_val if cr_val is not none else 'N/A' }}
            </td>
          </tr>
          <tr>
            <td class="text-muted"
              data-bs-toggle="tooltip"
              data-bs-title="RSI(14): ìƒëŒ€ê°•ë„ì§€ìˆ˜. 30â†“ ê³¼ë§¤ë„(ë§¤ìˆ˜ê¸°íšŒ), 70â†‘ ê³¼ë§¤ìˆ˜(ê³¼ì—´)">
              RSI(14) â„¹
            </td>
            {% set rsi_val = stock.rsi if (stock.rsi is defined and stock.rsi is not none) else none %}
            <td class="{% if rsi_val and rsi_val <= 30 %}text-danger fw-bold{% elif rsi_val and rsi_val >= 70 %}text-success{% endif %}">
              {% if rsi_val is not none %}
                {{ rsi_val }}
                {% if rsi_val <= 30 %}<span class="badge bg-danger ms-1" style="font-size:0.65rem">ê³¼ë§¤ë„</span>
                {% elif rsi_val >= 70 %}<span class="badge bg-success ms-1" style="font-size:0.65rem">ê³¼ë§¤ìˆ˜</span>{% endif %}
              {% else %}N/A{% endif %}
            </td>
          </tr>
          <tr>
            <td class="text-muted"
              data-bs-toggle="tooltip"
              data-bs-title="MACD(12,26,9): MACDì„  > Signalì„ ì´ë©´ ìƒìŠ¹ ëª¨ë©˜í…€, ì´í•˜ì´ë©´ í•˜ë½ ì¶”ì„¸">
              MACD â„¹
            </td>
            {% set macd_val = stock.macd_bullish if stock.macd_bullish is defined else none %}
            <td class="{% if macd_val == true %}text-success{% elif macd_val == false %}text-danger{% endif %}">
              {% if macd_val is not none %}
                {% if macd_val %}â†‘ ìƒìŠ¹ ëª¨ë©˜í…€{% else %}â†“ í•˜ë½ ì¶”ì„¸{% endif %}
              {% else %}N/A{% endif %}
            </td>
          </tr>
        </table>
      {% endif %}
    </div>
  </div>
  <div class="col-md-7">
    <div class="card p-3 h-100">
      <div class="small text-muted mb-2">ì• ë„ë¦¬ìŠ¤íŠ¸ íˆ¬ìì˜ê²¬ (ì´ {{ stock.analyst_count }}ëª…)</div>
      {% if stock.analyst_count > 0 %}
        {% set total = stock.strong_buy + stock.buy + stock.hold + stock.sell + stock.strong_sell %}
        {% if total > 0 %}
          <div class="mb-2">
            <div class="d-flex mb-1" style="height:22px; border-radius:4px; overflow:hidden">
              {% if stock.strong_buy %}
                <div class="bg-success" style="width:{{ (stock.strong_buy/total*100)|round }}%;opacity:.9" title="Strong Buy: {{stock.strong_buy}}"></div>
              {% endif %}
              {% if stock.buy %}
                <div class="bg-success" style="width:{{ (stock.buy/total*100)|round }}%" title="Buy: {{stock.buy}}"></div>
              {% endif %}
              {% if stock.hold %}
                <div class="bg-warning" style="width:{{ (stock.hold/total*100)|round }}%" title="Hold: {{stock.hold}}"></div>
              {% endif %}
              {% if stock.sell %}
                <div class="bg-danger" style="width:{{ (stock.sell/total*100)|round }}%;opacity:.8" title="Sell: {{stock.sell}}"></div>
              {% endif %}
              {% if stock.strong_sell %}
                <div class="bg-danger" style="width:{{ (stock.strong_sell/total*100)|round }}%" title="Strong Sell: {{stock.strong_sell}}"></div>
              {% endif %}
            </div>
            <div class="d-flex gap-3 small">
              <span class="text-success">Strong Buy {{ stock.strong_buy }}</span>
              <span class="text-success">Buy {{ stock.buy }}</span>
              <span class="text-warning">Hold {{ stock.hold }}</span>
              <span class="text-danger">Sell {{ stock.sell + stock.strong_sell }}</span>
            </div>
          </div>
        {% endif %}
        <table class="table table-sm mt-2">
          <tr>
            <td class="text-muted">Buy ë¹„ìœ¨</td>
            <td class="fw-bold {% if stock.buy_ratio_pct and stock.buy_ratio_pct >= 70 %}text-success{% endif %}">
              {{ stock.buy_ratio_pct ~ '%' if stock.buy_ratio_pct is not none else 'N/A' }}
            </td>
          </tr>
          <tr>
            <td class="text-muted">í‰ê·  ëª©í‘œì£¼ê°€</td>
            <td class="fw-bold">${{ "%.2f"|format(stock.target_price) if stock.target_price else 'N/A' }}</td>
          </tr>
          <tr>
            <td class="text-muted">ëª©í‘œê°€ Upside</td>
            <td class="{% if stock.target_upside_pct and stock.target_upside_pct > 0 %}text-success{% elif stock.target_upside_pct %}text-danger{% endif %} fw-bold">
              {{ ('+' if stock.target_upside_pct and stock.target_upside_pct > 0 else '') + stock.target_upside_pct|string + '%' if stock.target_upside_pct is not none else 'N/A' }}
            </td>
          </tr>
        </table>
      {% else %}
        <div class="text-muted small">ì• ë„ë¦¬ìŠ¤íŠ¸ ë°ì´í„° ì—†ìŒ (ETF ë˜ëŠ” ë°ì´í„° ë¯¸ì œê³µ)</div>
      {% endif %}
    </div>
  </div>
</div>

<!-- ì™¸ë¶€ ë§í¬ -->
<div class="mb-4">
  <div class="small text-muted mb-1">ì™¸ë¶€ ë¦¬ì„œì¹˜</div>
  <div class="d-flex gap-2">
    <a href="https://finance.yahoo.com/quote/{{ stock.ticker }}" target="_blank" class="btn btn-outline-primary btn-sm">Yahoo Finance</a>
    <a href="https://www.investing.com/search/?q={{ stock.ticker }}" target="_blank" class="btn btn-outline-secondary btn-sm">Investing.com</a>
    <a href="https://seekingalpha.com/symbol/{{ stock.ticker }}" target="_blank" class="btn btn-outline-secondary btn-sm">Seeking Alpha</a>
  </div>
</div>

<!-- ì¥ë‹¨ê¸° ê¸ˆë¦¬ì°¨ íŒ¨ë„í‹° í‘œì‹œ -->
{% if yield_curve and yield_curve.available and yield_curve.status != 'normal' %}
<div class="alert alert-{% if yield_curve.status == 'deeply_inverted' %}danger{% elif yield_curve.status == 'inverted' %}warning{% else %}info{% endif %} py-2 small mb-3">
  <strong>ì¥ë‹¨ê¸° ê¸ˆë¦¬ì°¨:</strong>
  {{ '%+.2f'|format(yield_curve.spread) }}% ({{ yield_curve.status_label }})
  &nbsp;|&nbsp; 10Y {{ yield_curve.rate_10y }}% / 2Y {{ yield_curve.rate_2y }}%
  {% if score.recession_penalty > 0 %}
    &nbsp;â†’ <strong>ì¶”ì²œ ì ìˆ˜ -{{ score.recession_penalty }}ì  ë°˜ì˜</strong>
  {% endif %}
</div>
{% endif %}

<div class="text-muted small">
  ë§ˆì§€ë§‰ ê°±ì‹ : {{ stock.updated }} &nbsp;|&nbsp;
  â€» ë³¸ ì •ë³´ëŠ” íˆ¬ì ì˜ì‚¬ê²°ì • ì°¸ê³ ìš©ì´ë©°, íˆ¬ì ì†ìµì— ëŒ€í•œ ì±…ì„ì€ íˆ¬ìì ë³¸ì¸ì—ê²Œ ìˆìŠµë‹ˆë‹¤.
</div>

<!-- â”€â”€ ë“±ê¸‰ ìƒì„¸ ë¶„ì„ ëª¨ë‹¬ â”€â”€ -->
<div class="modal fade" id="gradeModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header" id="modalHeader">
        <h5 class="modal-title" id="modalTitle">ì¢…ëª© ë¶„ì„</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- JSê°€ ì±„ì›Œì¤Œ -->
      </div>
      <div class="modal-footer">
        <small class="text-muted me-auto">â€» ê·œì¹™ ê¸°ë°˜ ì ìˆ˜ë¡œ íˆ¬ì ê²°ì •ì˜ ì°¸ê³  ìë£Œì…ë‹ˆë‹¤.</small>
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">ë‹«ê¸°</button>
      </div>
    </div>
  </div>
</div>

{% endif %}
{% endblock %}

{% block scripts %}
<script>
/* Bootstrap íˆ´íŒ ì´ˆê¸°í™” */
document.addEventListener("DOMContentLoaded", function () {
  document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(function (el) {
    new bootstrap.Tooltip(el, { placement: "top", trigger: "hover", html: true, sanitize: false });
  });
});

/* â”€â”€ ë“±ê¸‰ ë°°ì§€ í´ë¦­ â†’ ëª¨ë‹¬ ìƒì„¸ ë¶„ì„ â”€â”€ */
document.addEventListener("click", function (e) {
  var badge = e.target.closest(".grade-badge");
  if (!badge) return;

  var ticker     = badge.dataset.ticker;
  var name       = badge.dataset.name;
  var total      = parseInt(badge.dataset.total);
  var grade      = badge.dataset.grade;
  var gradeColor = badge.dataset.gradeColor;
  var fear       = parseInt(badge.dataset.fear);
  var ddScore    = parseInt(badge.dataset.drawdownScore);
  var fundScore  = badge.dataset.fundamental !== "" ? parseInt(badge.dataset.fundamental) : null;
  var recession  = parseInt(badge.dataset.recession || "0");
  var m2Adj      = parseInt(badge.dataset.m2Adj || "0");
  var techScore  = parseInt(badge.dataset.technical || "0");
  var rsiVal     = badge.dataset.rsi;
  var macdBull   = badge.dataset.macdBullish === "true";
  var maSignal   = badge.dataset.maSignal || "neutral";
  var athDd      = parseFloat(badge.dataset.athDrawdown);
  var buyRatio   = badge.dataset.buyRatio !== "" ? parseFloat(badge.dataset.buyRatio) : null;
  var fpe        = badge.dataset.forwardPe !== "" ? parseFloat(badge.dataset.forwardPe) : null;
  var roe        = badge.dataset.roe !== "" ? parseFloat(badge.dataset.roe) : null;
  var peg        = badge.dataset.peg !== "" ? parseFloat(badge.dataset.peg) : null;
  var fcf        = badge.dataset.fcf;
  var isEtf      = badge.dataset.isEtf === "true";
  var reason     = badge.dataset.reason;

  document.getElementById("modalHeader").style.background = gradeColor + "22";
  document.getElementById("modalTitle").innerHTML =
    ticker + " <small class='text-muted'>" + name.substring(0, 30) + "</small>" +
    " &nbsp;<span class='badge' style='background:" + gradeColor + "'>" + grade + "</span>";

  function fearDesc(s) {
    if (s >= 70) return '<strong>ğŸ”´ ê·¹ë„ ê³µí¬</strong> â€” íˆ¬ìì ëŒ€ë¶€ë¶„ì´ íŒ¨ë‹‰ ë§¤ë„ ì¤‘ì¸ ìƒíƒœì…ë‹ˆë‹¤.<br>ì—­ì‚¬ì ìœ¼ë¡œ ì´ êµ¬ê°„ì´ <em>ìµœê³ ì˜ ì €ê°€ ë§¤ìˆ˜ íƒ€ì´ë°</em>ì´ì—ˆìŠµë‹ˆë‹¤.<br><span class="text-info">ğŸ’¡ "ë‚¨ë“¤ì´ ë‘ë ¤ìš¸ ë•Œ ì‚¬ë¼" â€” ì›ŒëŸ° ë²„í•ì˜ íˆ¬ì ê²©ì–¸ì´ ì ìš©ë˜ëŠ” ìˆœê°„</span>';
    if (s >= 50) return '<strong>ğŸŸ  ê³µí¬</strong> â€” í•˜ë½ ê³µí¬ ì‹¬ë¦¬ê°€ í¼ì ¸ ì¢‹ì€ ì£¼ì‹ë„ ì €í‰ê°€ë˜ëŠ” ì‹œê¸°ì…ë‹ˆë‹¤.<br><span class="text-info">ğŸ’¡ ë¶„í•  ë§¤ìˆ˜ë¥¼ ì‹œì‘í•´ë³¼ ìˆ˜ ìˆëŠ” êµ¬ê°„ (í•œ ë²ˆì— ì‚¬ì§€ ë§ê³  ë‚˜ëˆ ì„œ ë§¤ìˆ˜)</span>';
    if (s >= 30) return '<strong>ğŸŸ¡ ë¶ˆì•ˆ</strong> â€” ì•½ê°„ì˜ í•˜ë½ ì••ë ¥ì´ ìˆì§€ë§Œ ê·¹ë‹¨ì  ê³µí¬ëŠ” ì•„ë‹™ë‹ˆë‹¤.<br><span class="text-info">ğŸ’¡ ì§€ì¼œë³´ë©° ë§¤ìˆ˜ ì¤€ë¹„ë¥¼ í•˜ëŠ” ë‹¨ê³„, ì•„ì§ ì„œë‘ë¥¼ í•„ìš” ì—†ìŒ</span>';
    return '<strong>ğŸŸ¢ ì•ˆì •Â·íƒìš•</strong> â€” íˆ¬ììë“¤ì´ ë‚™ê´€ì ì´ë¼ ê°€ê²©ì´ ê³ í‰ê°€ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br><span class="text-info">ğŸ’¡ ì‹ ê·œ ë§¤ìˆ˜ë³´ë‹¤ ê¸°ì¡´ ë³´ìœ  ì¢…ëª© ì ê²€ ê¶Œì¥. ì¢‹ì€ ê¸°íšŒëŠ” ê³µí¬ ì‹œì— ì˜µë‹ˆë‹¤.</span>';
  }
  function ddDesc(d) {
    if (d == null) return "ë‚™í­ ë°ì´í„° ì—†ìŒ";
    var pct = Math.abs(d);
    var label, guide;
    if (pct >= 50) { label = "ë°˜í† ë§‰ ìˆ˜ì¤€ ğŸ”´"; guide = "ê³ ì  ëŒ€ë¹„ ì ˆë°˜ ì´ìƒ í•˜ë½í•œ ìƒíƒœì…ë‹ˆë‹¤. íšŒì‚¬ ê¸°ì´ˆì²´ë ¥(í€ë”ë©˜íƒˆ)ì´ ê±´ì¬í•˜ë‹¤ë©´ ì—­ì‚¬ì  ìµœê³ ì˜ ë§¤ìˆ˜ ê¸°íšŒì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤."; }
    else if (pct >= 30) { label = "í° ì¡°ì • ğŸŸ "; guide = "ê³ ì  ëŒ€ë¹„ í¬ê²Œ ë‚´ë ¤ì˜¨ êµ¬ê°„ì…ë‹ˆë‹¤. í€ë”ë©˜íƒˆì´ ì¢‹ë‹¤ë©´ <strong>ë¶„í•  ë§¤ìˆ˜ë¥¼ ì ê·¹ ê²€í† </strong>í•˜ì„¸ìš”."; }
    else if (pct >= 20) { label = "ì¤‘ê°„ ì¡°ì • ğŸŸ¡"; guide = "ì˜ë¯¸ìˆëŠ” ì¡°ì •ì´ì§€ë§Œ ì¶”ê°€ í•˜ë½ ì—¬ì§€ë„ ìˆìŠµë‹ˆë‹¤. ì†ŒëŸ‰ì”© ë‚˜ëˆ  ì ‘ê·¼í•˜ì„¸ìš”."; }
    else if (pct >= 10) { label = "ì†Œí­ ì¡°ì • âšª"; guide = "ì•„ì§ ì¶©ë¶„íˆ ì €ë ´í•œ êµ¬ê°„ì´ ì•„ë‹™ë‹ˆë‹¤. ë” í° í•˜ë½ì„ ê¸°ë‹¤ë¦¬ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤."; }
    else                { label = "ê³ ì  ê·¼ì²˜ âšª"; guide = "ì—­ëŒ€ ìµœê³ ê°€ ê·¼ì²˜ì…ë‹ˆë‹¤. ê³ ì  ë§¤ìˆ˜ ë¦¬ìŠ¤í¬ê°€ ìˆìœ¼ë¯€ë¡œ ì‹ ì¤‘íˆ íŒë‹¨í•˜ì„¸ìš”."; }
    return 'ATH(ì—­ëŒ€ ìµœê³ ê°€) ëŒ€ë¹„ <strong>' + d + '%</strong> â€” ' + label + '<br><span class="text-muted">' + guide + '</span><br><span class="text-info" style="font-size:0.75em">ğŸ’¡ ATH = All-Time High, ìƒì¥ ì´í›„ ê°€ì¥ ë†’ì•˜ë˜ ì£¼ê°€</span>';
  }
  function fundDesc(score, buy, pe, roe, peg, fcf) {
    if (score == null) return 'ETFëŠ” í€ë”ë©˜íƒˆ(ì¬ë¬´) ì ìˆ˜ë¥¼ ì‚°ì¶œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.<br><span class="text-muted">ETF ì ìˆ˜ = ì‹œì¥ ê³µí¬ + ë‚™í­ + ê¸°ìˆ ì  ì§€í‘œë¡œë§Œ ê³„ì‚°ë©ë‹ˆë‹¤.</span>';
    var lines = [];
    if (buy != null) {
      var bi = buy >= 70 ? "âœ…" : buy >= 50 ? "ğŸŸ¡" : "âŒ";
      var bl = buy >= 70 ? "ê°•ë ¥ ë§¤ìˆ˜ ì¶”ì²œ" : buy >= 50 ? "ë§¤ìˆ˜ ìš°ì„¸" : "ë§¤ìˆ˜ ì˜ê²¬ ë‚®ìŒ";
      lines.push(bi + ' ì• ë„ë¦¬ìŠ¤íŠ¸ <strong>Buyë¹„ìœ¨ ' + buy + '%</strong> â€” ' + bl);
      lines.push('<span class="text-muted" style="font-size:0.75em">ì›”ê°€ ì „ë¬¸ ì• ë„ë¦¬ìŠ¤íŠ¸ë“¤ì´ ì´ ì¢…ëª©ì„ ë§¤ìˆ˜ ì¶”ì²œí•˜ëŠ” ë¹„ìœ¨. 70% ì´ìƒì´ë©´ ì „ë¬¸ê°€ ì˜ê²¬ì´ ê¸ì •ì .</span>');
    }
    if (peg != null) {
      var pi = peg < 1 ? "âœ…" : peg <= 2 ? "ğŸŸ¡" : "âŒ";
      var pl = peg < 1 ? "ì„±ì¥ ëŒ€ë¹„ ì €í‰ê°€ ğŸ¯" : peg <= 2 ? "ì ì • ë°¸ë¥˜ì—ì´ì…˜" : "ê³ í‰ê°€ ì£¼ì˜";
      lines.push(pi + ' <strong>PEG ' + peg + '</strong> â€” ' + pl);
      lines.push('<span class="text-muted" style="font-size:0.75em">PEG = PER Ã· ì„±ì¥ë¥ . 1 ë¯¸ë§Œì´ë©´ ì„±ì¥ì„±ì— ë¹„í•´ ì£¼ê°€ê°€ ì €ë ´í•œ ê²ƒ. ì„±ì¥ì£¼ íŒë‹¨ì— ìœ ìš©.</span>');
    } else if (pe != null) {
      var pei = pe < 20 ? "âœ…" : pe < 30 ? "ğŸŸ¡" : "âŒ";
      var pel = pe < 15 ? "ì €í‰ê°€" : pe < 20 ? "ì ì •" : pe < 30 ? "ë‹¤ì†Œ ê³ í‰ê°€" : "ê³ í‰ê°€ ì£¼ì˜";
      lines.push(pei + ' <strong>Forward PER ' + pe + '</strong> â€” ' + pel);
      lines.push('<span class="text-muted" style="font-size:0.75em">PER = ì£¼ê°€ Ã· ìˆœì´ìµ. ë‚´ë…„ ì˜ˆìƒ ì‹¤ì  ê¸°ì¤€. ë‚®ì„ìˆ˜ë¡ ì‹¸ê²Œ ì‚¬ëŠ” ê²ƒ. (ì—…ì¢… í‰ê· ê³¼ ë¹„êµ ê¶Œì¥)</span>');
    }
    if (roe != null) {
      var ri = roe >= 20 ? "âœ…" : roe >= 15 ? "ğŸŸ¡" : "âšª";
      var rl = roe >= 20 ? "ìš°ìˆ˜" : roe >= 15 ? "ì–‘í˜¸" : "ë³´í†µ";
      lines.push(ri + ' <strong>ROE ' + roe + '%</strong> â€” ìë³¸ íš¨ìœ¨ì„± ' + rl);
      lines.push('<span class="text-muted" style="font-size:0.75em">ROE = ìˆœì´ìµ Ã· ìê¸°ìë³¸. íˆ¬ìí•œ ëˆ ëŒ€ë¹„ ì–¼ë§ˆë‚˜ ë²Œì—ˆëŠ”ì§€. 15% ì´ìƒì´ë©´ ìš°ìˆ˜í•œ ê¸°ì—….</span>');
    }
    if (fcf) {
      var fi = fcf === "ì–‘í˜¸" ? "âœ…" : "âŒ";
      var fl = fcf === "ì–‘í˜¸" ? "ì¬ë¬´ ê±´ì „ â€” ë°°ë‹¹Â·ìì‚¬ì£¼ë§¤ì…Â·íˆ¬ì ì—¬ë ¥ ìˆìŒ" : "í˜„ê¸ˆ ë¶€ì¡± â€” ì„±ì¥ íˆ¬ìë‚˜ ë¶€ì±„ ìƒí™˜ì— ì£¼ì˜ í•„ìš”";
      lines.push(fi + ' <strong>ì‰ì—¬í˜„ê¸ˆíë¦„(FCF)</strong> ' + fcf + ' â€” ' + fl);
      lines.push('<span class="text-muted" style="font-size:0.75em">FCF = ì˜ì—… í›„ ë‚¨ëŠ” ì‹¤ì œ í˜„ê¸ˆ. ì–‘ìˆ˜ì¼ìˆ˜ë¡ íšŒì‚¬ê°€ ì‹¤ì œë¡œ ëˆì„ ì˜ ë²„ëŠ” ê²ƒ.</span>');
    }
    return lines.length ? lines.join("<br>") : "í€ë”ë©˜íƒˆ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.";
  }
  function techDesc(score, rsi, macdBull, maSignal) {
    var lines = [];
    if (rsi !== null && rsi !== "" && rsi !== undefined) {
      var rv = parseFloat(rsi);
      var ri = rv <= 30 ? "âœ…" : rv <= 40 ? "ğŸŸ¡" : rv >= 70 ? "âŒ" : "âšª";
      var rl = rv <= 30 ? "ê³¼ë§¤ë„ â€” ë°˜ë“± ê°•ë ¥ ì‹ í˜¸ ğŸ¯" : rv <= 40 ? "ì•½ì„¸ê¶Œ â€” ë°˜ë“± ê°€ëŠ¥ì„±" : rv <= 50 ? "ì¤‘ë¦½â†“" : rv < 70 ? "ì¤‘ë¦½â†‘" : "ê³¼ë§¤ìˆ˜ â€” ë‹¨ê¸° ì¡°ì • ì£¼ì˜";
      lines.push(ri + ' <strong>RSI(14): ' + rv + '</strong> â€” ' + rl);
      lines.push('<span class="text-muted" style="font-size:0.75em">RSIëŠ” ìµœê·¼ 14ì¼ ìƒìŠ¹Â·í•˜ë½ í˜ì˜ ë¹„ìœ¨. 30â†“ "ë„ˆë¬´ ë§ì´ íŒ”ë ¸ë‹¤(ì €í‰ê°€)", 70â†‘ "ë„ˆë¬´ ë§ì´ ì˜¬ëë‹¤(ê³¼ì—´)"</span>');
    }
    var mi = (macdBull === true || macdBull === "true") ? "âœ…" : "âŒ";
    var ml = (macdBull === true || macdBull === "true") ? "ìƒìŠ¹ ëª¨ë©˜í…€ â€” ë‹¨ê¸° ì¶”ì„¸ê°€ ì˜¬ë¼ê°€ëŠ” ì¤‘" : "í•˜ë½ ëª¨ë©˜í…€ â€” ë‹¨ê¸° ì¶”ì„¸ê°€ ë‚´ë ¤ê°€ëŠ” ì¤‘";
    lines.push(mi + ' <strong>MACD</strong>: ' + ml);
    lines.push('<span class="text-muted" style="font-size:0.75em">MACD = ë‹¨ê¸°(12ì¼)Â·ì¥ê¸°(26ì¼) ì´ë™í‰ê·  ì°¨ì´. ë‹¨ê¸°ê°€ ì¥ê¸°ë¥¼ ìœ„ë¡œ êµì°¨í•˜ë©´ ìƒìŠ¹ ì „í™˜ ì‹ í˜¸</span>');
    var si = maSignal === "bullish" ? "âœ…" : maSignal === "bearish" ? "âŒ" : "ğŸŸ¡";
    var sl = maSignal === "bullish" ? "í™©ê¸ˆ ë°°ì—´ â€” ê°€ê²© > MA20 > MA60, ìƒìŠ¹ ì¶”ì„¸ í™•ì¸" : maSignal === "bearish" ? "ì—­ë°°ì—´ â€” ê°€ê²© < MA20 < MA60, í•˜ë½ ì¶”ì„¸" : "ì¤‘ë¦½ â€” ë°©í–¥ì„± ë¶ˆë¶„ëª…";
    lines.push(si + ' <strong>ì´ë™í‰ê·  ë°°ì—´</strong>: ' + sl);
    lines.push('<span class="text-muted" style="font-size:0.75em">ì´ë™í‰ê· (MA) = ìµœê·¼ Nì¼ í‰ê·  ì£¼ê°€. ë‹¨ê¸°ì„ ì´ ì¥ê¸°ì„  ìœ„ì— ìˆìœ¼ë©´ "ìƒìŠ¹ ì¶”ì„¸", ì•„ë˜ë©´ "í•˜ë½ ì¶”ì„¸"</span>');
    return lines.join("<br>");
  }
  function recessionDesc(penalty) {
    if (penalty >= 25) return '<strong>ğŸ”´ ì‹¬ê°í•œ ê²½ê¸°ì¹¨ì²´ ê²½ê³ </strong> â€” ì¥ë‹¨ê¸° ê¸ˆë¦¬ì°¨ê°€ í¬ê²Œ ì—­ì „ë˜ì—ˆìŠµë‹ˆë‹¤.<br>ê³¼ê±° ì‚¬ë¡€ìƒ 1~2ë…„ ë‚´ ê²½ê¸°ì¹¨ì²´ê°€ ë°œìƒí•œ ê°•ë ¥í•œ ì„ í–‰ì§€í‘œì…ë‹ˆë‹¤.<br><span class="text-muted" style="font-size:0.75em">ì¥ê¸°ì±„ ê¸ˆë¦¬ê°€ ë‚®ë‹¤ëŠ” ê±´ ì‹œì¥ì´ "ë¯¸ë˜ ê²½ê¸°ê°€ ë‚˜ë¹ ì§ˆ ê²ƒ"ì„ ì˜ˆìƒí•œë‹¤ëŠ” ì‹ í˜¸</span><br>ì ìˆ˜ -25ì  ì°¨ê°.';
    if (penalty >= 15) return '<strong>ğŸŸ  ê¸ˆë¦¬ì°¨ ì—­ì „</strong> â€” ë‹¨ê¸° ê¸ˆë¦¬ê°€ ì¥ê¸° ê¸ˆë¦¬ë³´ë‹¤ ë†’ì•„ì§„ ìƒíƒœì…ë‹ˆë‹¤.<br>ì—­ì‚¬ì ìœ¼ë¡œ 6~18ê°œì›” ë‚´ ê²½ê¸°ì¹¨ì²´ì˜ ì„ í–‰ ì‹ í˜¸ë¡œ ì•Œë ¤ì ¸ ìˆìŠµë‹ˆë‹¤. ì ìˆ˜ -15ì  ì°¨ê°.';
    if (penalty >= 5)  return '<strong>ğŸŸ¡ ê¸ˆë¦¬ì°¨ í”Œë«</strong> â€” ì¥ë‹¨ê¸° ê¸ˆë¦¬ì°¨ê°€ ê±°ì˜ ì—†ëŠ” ìƒíƒœì…ë‹ˆë‹¤.<br>ê²½ê¸° ë‘”í™” ê°€ëŠ¥ì„±ì— ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤. ì ìˆ˜ -5ì  ì°¨ê°.';
    return '<strong>ğŸŸ¢ ì •ìƒ</strong> â€” ì¥ê¸° ê¸ˆë¦¬ > ë‹¨ê¸° ê¸ˆë¦¬ì˜ ê±´ê°•í•œ êµ¬ì¡°ì…ë‹ˆë‹¤. ê²½ê¸°ì¹¨ì²´ íŒ¨ë„í‹° ì—†ìŒ.<br><span class="text-muted" style="font-size:0.75em">ì •ìƒ: 10ë…„ ë§Œê¸° ì±„ê¶Œ ê¸ˆë¦¬ > 2ë…„ ë§Œê¸° ì±„ê¶Œ ê¸ˆë¦¬ (ë¯¸ë˜ ê²½ê¸° íšŒë³µ ê¸°ëŒ€)</span>';
  }
  function m2Desc(adj) {
    if (adj >= 10) return '<strong>ğŸ’§ ìœ ë™ì„± ê³¼ì‰</strong> â€” M2 í†µí™”ëŸ‰ì´ ì „ë…„ ëŒ€ë¹„ 15% ì´ìƒ ê¸‰ì¦í–ˆìŠµë‹ˆë‹¤.<br>ì‹œì¤‘ì— ëˆì´ ë„˜ì³ ì£¼ì‹ ë“± ìœ„í—˜ìì‚°ìœ¼ë¡œ ìœ ì…ë  ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.<br><span class="text-muted" style="font-size:0.75em">M2 = ì‹œì¤‘ì— ìœ í†µë˜ëŠ” ëˆì˜ ì´ëŸ‰. ëˆì´ ë§ì•„ì§€ë©´ ì£¼ì‹ìœ¼ë¡œ í˜ëŸ¬ë“¤ì–´ ì£¼ê°€ ìƒìŠ¹ ë™ë ¥ì´ ë¨</span><br>+10ì  ê°€ì‚°.';
    if (adj >= 5)  return '<strong>ğŸ’§ ìœ ë™ì„± í’ë¶€</strong> â€” M2 í†µí™”ëŸ‰ì´ ì „ë…„ ëŒ€ë¹„ 7~15% ì¦ê°€í–ˆìŠµë‹ˆë‹¤.<br>ì ë‹¹í•œ ìœ ë™ì„± í™•ì¥ìœ¼ë¡œ ì¦ì‹œì— ìš°í˜¸ì ì¸ í™˜ê²½ì…ë‹ˆë‹¤. +5ì  ê°€ì‚°.';
    if (adj >= 0)  return '<strong>âšª ìœ ë™ì„± ì¤‘ë¦½</strong> â€” M2 í†µí™”ëŸ‰ì´ 0~7% ë²”ìœ„ë¡œ ì•ˆì •ì ì…ë‹ˆë‹¤.<br>ì ìˆ˜ ì¡°ì • ì—†ìŒ. ê±´ê°•í•œ í†µí™” ì„±ì¥ ë²”ìœ„ì…ë‹ˆë‹¤.';
    if (adj >= -7) return '<strong>âš  ìœ ë™ì„± ìˆ˜ì¶•</strong> â€” M2 í†µí™”ëŸ‰ì´ ê°ì†Œí•˜ê³  ìˆìŠµë‹ˆë‹¤.<br>ì‹œì¤‘ ìê¸ˆì´ ì¤„ì–´ ì¦ì‹œ ìƒìŠ¹ ë™ë ¥ì´ ì•½í•´ì§‘ë‹ˆë‹¤. -7ì  ì°¨ê°.';
    return '<strong>ğŸ”´ ìœ ë™ì„± ê¸‰ê²© ìˆ˜ì¶•</strong> â€” M2 í†µí™”ëŸ‰ì´ ì „ë…„ ëŒ€ë¹„ 2% ì´ìƒ ê¸‰ê°í–ˆìŠµë‹ˆë‹¤.<br>ì—­ì‚¬ì ìœ¼ë¡œ ê°•í•œ ì¦ì‹œ í•˜ë½ ì••ë ¥ê³¼ ì—°ê´€ë©ë‹ˆë‹¤. -15ì  ì°¨ê°.';
  }
  function gradeDesc(g, isEtf) {
    if (g.includes("ê°•ë ¥")) return 'ğŸ† <strong>ìµœì  ë§¤ìˆ˜ íƒ€ì´ë°</strong> â€” ì‹œì¥ ê³µí¬Â·ë‚™í­Â·ê¸°ìˆ ì  ì§€í‘œê°€ ëª¨ë‘ ìš°í˜¸ì ì…ë‹ˆë‹¤.<br>70ì  ì´ìƒì€ ì—­ì‚¬ì ìœ¼ë¡œ ë†’ì€ ìˆ˜ìµë¥ ì„ ê¸°ë¡í•œ êµ¬ê°„ì…ë‹ˆë‹¤.<br><span class="text-info">ğŸ’¡ ë¶„í•  ë§¤ìˆ˜ë¥¼ ì ê·¹ ê³ ë ¤í•˜ì„¸ìš”. (ì˜ˆ: 3ë²ˆì— ë‚˜ëˆ ì„œ ë§¤ìˆ˜)</span>';
    if (g.includes("ë§¤ìˆ˜ ê³ ë ¤")) return 'âœ… <strong>ë§¤ìˆ˜ ê³ ë ¤ êµ¬ê°„</strong> â€” ì¼ë¶€ ì¡°ê±´ì´ ì¶©ì¡±ëœ ìƒíƒœì…ë‹ˆë‹¤.<br><span class="text-info">ğŸ’¡ í•œ ë²ˆì— í° ê¸ˆì•¡ë³´ë‹¤ ì†ŒëŸ‰ì”© ë‚˜ëˆ  ë§¤ìˆ˜(ë¶„í•  ë§¤ìˆ˜)í•˜ëŠ” ë°©ì‹ì„ ê¶Œì¥í•©ë‹ˆë‹¤.</span>';
    if (g.includes("ê´€ë§")) return 'ğŸ”µ <strong>ê´€ë§ ë‹¨ê³„</strong> â€” ë§¤ìˆ˜ ì¡°ê±´ì´ ë¶€ë¶„ì ìœ¼ë¡œë§Œ ì¶©ì¡±ë©ë‹ˆë‹¤.<br>ì¶”ê°€ í•˜ë½ ì‹œ ë§¤ìˆ˜ ì‹ í˜¸ê°€ ê°•í•´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br><span class="text-info">ğŸ’¡ í˜„ê¸ˆì„ ë³´ìœ í•˜ë©° ë” ì¢‹ì€ ê¸°íšŒë¥¼ ê¸°ë‹¤ë¦¬ì„¸ìš”.</span>';
    return 'âšª <strong>ë§¤ìˆ˜ ë³´ë¥˜</strong> â€” í˜„ì¬ ë§¤ìˆ˜ ì¡°ê±´ì´ ë¶ˆì¶©ë¶„í•©ë‹ˆë‹¤.<br>ì‹œì¥ì´ ì•ˆì •ë˜ê±°ë‚˜ ê°€ê²©ì´ ë” ë‚´ë ¤ì˜¬ ë•Œë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ê²ƒì´ ìœ ë¦¬í•©ë‹ˆë‹¤.';
  }
  function progressBar(score, max, color) {
    var pct = max > 0 ? Math.round(score / max * 100) : 0;
    return '<div class="progress" style="height:10px"><div class="progress-bar" style="width:' +
      pct + '%;background:' + color + '">' + score + '/' + max + '</div></div>';
  }

  /* ì¡°ì • ì „ ì›ì ìˆ˜ (ë³´ë„ˆìŠ¤ ë¹¼ê³ , íŒ¨ë„í‹° ë”í•´ í™˜ì›) */
  var baseScore = total + recession - m2Adj;
  var html = '';

  html += '<div class="mb-4">';
  html += '<div class="d-flex align-items-center gap-3 mb-2">';
  html += '<div class="text-center" style="min-width:80px">';
  html += '<div class="display-4 fw-bold" style="color:' + gradeColor + '">' + total + '</div>';
  html += '<div class="small text-muted">/ 100ì </div></div>';
  html += '<div class="flex-grow-1">';
  html += progressBar(total, 100, gradeColor);
  html += '<div class="mt-2 small">' + gradeDesc(grade, isEtf) + '</div>';
  html += '</div></div>';
  if (recession > 0 || m2Adj !== 0) {
    var adjParts = [];
    if (recession > 0) adjParts.push("ì¹¨ì²´ -" + recession + "ì ");
    if (m2Adj > 0)     adjParts.push('<span class="text-success fw-bold">M2 ìœ ë™ì„± +' + m2Adj + 'ì </span>');
    if (m2Adj < 0)     adjParts.push("M2ìˆ˜ì¶• " + m2Adj + "ì ");
    var alertCls = (recession > 0 || m2Adj < 0) ? "warning" : "success";
    var alertIcon = (m2Adj > 0 && recession === 0) ? "ğŸ’§" : "âš ";
    html += '<div class="alert alert-' + alertCls + ' py-1 small mb-0">' + alertIcon + ' ì ìˆ˜ ì¡°ì •: ' +
      adjParts.join(", ") + ' (ì›ì ìˆ˜: ' + baseScore + 'ì )</div>';
  }
  html += '</div>';

  /* 4ê°œ ì ìˆ˜ ì¹´ë“œ */
  html += '<div class="row g-3 mb-3">';

  html += '<div class="col-md-3"><div class="card p-3 h-100 border-danger border-opacity-25">';
  html += '<div class="small fw-bold text-danger mb-1">ğŸ”´ ì‹œì¥ ê³µí¬ &nbsp;' + fear + '/100</div>';
  html += progressBar(fear, 100, "#e74c3c");
  html += '<div class="small text-muted mt-2">' + fearDesc(fear) + '</div>';
  html += '</div></div>';

  html += '<div class="col-md-3"><div class="card p-3 h-100 border-warning border-opacity-25">';
  html += '<div class="small fw-bold text-warning mb-1">ğŸŸ  ë‚™í­ &nbsp;' + ddScore + '/100</div>';
  html += progressBar(ddScore, 100, "#f39c12");
  html += '<div class="small text-muted mt-2">' + ddDesc(athDd) + '</div>';
  html += '</div></div>';

  html += '<div class="col-md-3"><div class="card p-3 h-100 border-success border-opacity-25">';
  html += '<div class="small fw-bold text-success mb-1">ğŸŸ¢ í€ë”ë©˜íƒˆ ' +
    (fundScore != null ? fundScore + '/100' : 'ETF') + '</div>';
  if (fundScore != null) html += progressBar(fundScore, 100, "#27ae60");
  html += '<div class="small text-muted mt-2">' + fundDesc(fundScore, buyRatio, fpe, roe, peg, fcf) + '</div>';
  html += '</div></div>';

  html += '<div class="col-md-3"><div class="card p-3 h-100 border-info border-opacity-25">';
  html += '<div class="small fw-bold text-info mb-1">ğŸ”µ ê¸°ìˆ ì  &nbsp;' + techScore + '/100</div>';
  html += progressBar(techScore, 100, "#2980b9");
  html += '<div class="small text-muted mt-2">' + techDesc(techScore, rsiVal, macdBull, maSignal) + '</div>';
  html += '</div></div>';

  html += '</div>';

  /* ì¹¨ì²´ ë¦¬ìŠ¤í¬ + M2 ìœ ë™ì„± */
  html += '<div class="row g-3 mb-3">';
  html += '<div class="col-md-6"><div class="card p-3 h-100 border-' +
    (recession >= 25 ? "danger" : recession >= 15 ? "warning" : recession >= 5 ? "info" : "success") +
    ' border-opacity-25">';
  html += '<div class="small fw-bold mb-1">ğŸ“‰ ê²½ê¸°ì¹¨ì²´ ë¦¬ìŠ¤í¬</div>';
  html += '<div class="small text-muted">' + recessionDesc(recession) + '</div>';
  html += '</div></div>';

  html += '<div class="col-md-6"><div class="card p-3 h-100 border-' +
    (m2Adj <= -15 ? "danger" : m2Adj <= -7 ? "warning" : m2Adj >= 5 ? "success" : "secondary") +
    ' border-opacity-25">';
  html += '<div class="small fw-bold mb-1">ğŸ’§ ìœ ë™ì„±(M2) ' + (m2Adj > 0 ? 'ë³´ë„ˆìŠ¤' : 'í˜„í™©') + '</div>';
  html += '<div class="small text-muted">' + m2Desc(m2Adj) + '</div>';
  html += '</div></div>';
  html += '</div>';

  /* ì ìˆ˜ ê³„ì‚°ì‹ */
  html += '<div class="card bg-light p-3 small">';
  html += '<div class="fw-bold mb-1">ğŸ“ ì ìˆ˜ ê³„ì‚°ì‹</div>';
  if (isEtf) {
    html += '<code>' + fear + ' Ã— 0.35 + ' + ddScore + ' Ã— 0.35 + ' +
      techScore + ' Ã— 0.30 = ' + baseScore + 'ì </code>';
    html += ' (ETF: ê³µí¬Â·ë‚™í­Â·ê¸°ìˆ ì )';
  } else {
    html += '<code>' + fear + ' Ã— 0.25 + ' + ddScore + ' Ã— 0.30 + ' +
      (fundScore || 0) + ' Ã— 0.25 + ' + techScore + ' Ã— 0.20 = ' + baseScore + 'ì </code>';
    html += ' (ì£¼ì‹: ê³µí¬Â·ë‚™í­Â·í€ë”ë©˜íƒˆÂ·ê¸°ìˆ ì )';
  }
  if (recession > 0 || m2Adj !== 0) {
    if (recession > 0) html += ' &nbsp;- <span class="text-danger">' + recession + 'ì (ì¹¨ì²´)</span>';
    if (m2Adj > 0)     html += ' &nbsp;+ <span class="text-success">' + m2Adj + 'ì (M2ë³´ë„ˆìŠ¤)</span>';
    if (m2Adj < 0)     html += ' &nbsp;- <span class="text-warning">' + Math.abs(m2Adj) + 'ì (M2ìˆ˜ì¶•)</span>';
    html += ' = <strong>' + total + 'ì </strong>';
  }
  html += '</div>';

  document.getElementById("modalBody").innerHTML = html;

  /* ëª¨ë‹¬ ì§ì ‘ ì—´ê¸° */
  var modalEl = document.getElementById("gradeModal");
  var modal = bootstrap.Modal.getOrCreateInstance(modalEl);
  modal.show();
});
</script>
{% if stock.price_history %}
<script>
(function () {
  /* â”€â”€ ì°¨íŠ¸ ë°ì´í„° ì¤€ë¹„ â”€â”€ */
  var history = {{ stock.price_history | tojson }};
  var labels  = history.map(function(d) { return d.date; });
  var prices  = history.map(function(d) { return d.close; });
  var volumes = history.map(function(d) { return d.volume || 0; });
  var ma20    = history.map(function(d) { return d.ma20; });
  var ma60    = history.map(function(d) { return d.ma60; });
  var ma120   = history.map(function(d) { return d.ma120; });

  /* xì¶• ëˆˆê¸ˆ: ì›” ë‹¨ìœ„ë¡œ í‘œì‹œ */
  var xLabels = labels.map(function(d, i) {
    if (i === 0) return d.slice(0, 7);
    return labels[i].slice(5, 7) !== labels[i-1].slice(5, 7) ? d.slice(0, 7) : '';
  });

  /* â”€â”€ ì£¼ê°€ + ì´ë™í‰ê·  ì°¨íŠ¸ â”€â”€ */
  new Chart(document.getElementById('priceChart'), {
    type: 'line',
    data: {
      labels: xLabels,
      datasets: [
        {
          /* ì¢…ê°€ (ë©”ì¸ ë¼ì¸ + ë°°ê²½ ì±„ìš°ê¸°) */
          label: 'ì¢…ê°€',
          data: prices,
          borderColor: '#3498db',
          backgroundColor: 'rgba(52,152,219,0.07)',
          borderWidth: 1.5,
          pointRadius: 0,
          fill: true,
          tension: 0.2,
          order: 4,
        },
        {
          /* 20ì¼ ì´ë™í‰ê·  */
          label: 'MA20',
          data: ma20,
          borderColor: '#e67e22',
          borderWidth: 1.2,
          pointRadius: 0,
          fill: false,
          tension: 0.2,
          order: 3,
        },
        {
          /* 60ì¼ ì´ë™í‰ê·  */
          label: 'MA60',
          data: ma60,
          borderColor: '#9b59b6',
          borderWidth: 1.2,
          pointRadius: 0,
          fill: false,
          tension: 0.2,
          order: 2,
        },
        {
          /* 120ì¼ ì´ë™í‰ê·  */
          label: 'MA120',
          data: ma120,
          borderColor: '#e74c3c',
          borderWidth: 1.5,
          pointRadius: 0,
          fill: false,
          tension: 0.2,
          order: 1,
        },
      ]
    },
    options: {
      responsive: true,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            /* íˆ´íŒì—ì„œ null ê°’ ì œì™¸ */
            label: function(ctx) {
              if (ctx.parsed.y === null) return null;
              return ctx.dataset.label + ': $' + ctx.parsed.y.toFixed(2);
            }
          }
        }
      },
      scales: {
        x: { ticks: { maxTicksLimit: 8, maxRotation: 0 } },
        y: { ticks: { callback: function(v) { return '$' + v; } } }
      }
    }
  });

  /* â”€â”€ ê±°ë˜ëŸ‰ ì°¨íŠ¸ â”€â”€ */
  /* ê±°ë˜ëŸ‰ì´ í‰ê·  ëŒ€ë¹„ 2ë°° ì´ìƒì´ë©´ ê°•ì¡°ìƒ‰ */
  var avgVol = volumes.reduce(function(a, b) { return a + b; }, 0) / volumes.length;
  var volColors = volumes.map(function(v) {
    return v >= avgVol * 2
      ? 'rgba(231,76,60,0.7)'    /* ê¸‰ë“± ê±°ë˜ëŸ‰: ë¹¨ê°• */
      : 'rgba(52,152,219,0.5)';  /* ë³´í†µ ê±°ë˜ëŸ‰: íŒŒë‘ */
  });

  new Chart(document.getElementById('volumeChart'), {
    type: 'bar',
    data: {
      labels: xLabels,
      datasets: [{
        label: 'ê±°ë˜ëŸ‰',
        data: volumes,
        backgroundColor: volColors,
        borderWidth: 0,
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { maxTicksLimit: 8, maxRotation: 0 } },
        y: {
          ticks: {
            /* ê±°ë˜ëŸ‰ ë‹¨ìœ„: M(ë°±ë§Œ) / B(ì‹­ì–µ) */
            callback: function(v) {
              if (v >= 1e9) return (v / 1e9).toFixed(1) + 'B';
              if (v >= 1e6) return (v / 1e6).toFixed(0) + 'M';
              return v;
            }
          }
        }
      }
    }
  });

  /* â”€â”€ ì‹¤ì‹œê°„ ê°€ê²© AJAX ê°±ì‹  (10ì´ˆ ì£¼ê¸°) â”€â”€ */
  var TICKER = '{{ stock.ticker }}';

  function fetchPrice() {
    fetch('/api/prices')
      .then(function(r) { return r.json(); })
      .then(function(data) {
        var item = data[TICKER];
        if (!item || !item.price) return;

        var priceEl  = document.getElementById('detailPrice');
        var changeEl = document.getElementById('detailChange');
        var updEl    = document.getElementById('detailUpdatedAt');

        if (!priceEl) return;

        var oldPrice = parseFloat(priceEl.dataset.price || 0);
        var newPrice = item.price;

        /* ê°€ê²© ë³€ê²½ ì‹œ ì—…ë°ì´íŠ¸ + ë°°ê²½ í”Œë˜ì‹œ */
        if (Math.abs(newPrice - oldPrice) >= 0.01) {
          priceEl.dataset.price = newPrice;
          priceEl.textContent = '$' + newPrice.toFixed(2);

          /* ë°©í–¥ ìƒ‰ìƒ (ì¼ì‹œì ìœ¼ë¡œ) */
          priceEl.style.transition = 'color 0.3s';
          priceEl.style.color = newPrice > oldPrice ? '#27ae60' : '#e74c3c';
          setTimeout(function() { priceEl.style.color = ''; }, 2000);
        }

        /* ì „ì¼ ëŒ€ë¹„ ë³€ë™ë¥  í‘œì‹œ */
        if (changeEl && item.change_pct !== null) {
          var sign  = item.change_pct >= 0 ? '+' : '';
          changeEl.textContent = '(' + sign + item.change_pct + '%)';
          changeEl.className = 'small ' + (item.change_pct >= 0 ? 'text-success' : 'text-danger');
        }

        /* ë§ˆì§€ë§‰ ê°±ì‹  ì‹œê° */
        if (updEl) {
          updEl.textContent = new Date().toLocaleTimeString('ko-KR') + ' ê°±ì‹ ';
        }
      })
      .catch(function() {});
  }

  /* í˜ì´ì§€ ì§„ì… ì¦‰ì‹œ + ì´í›„ 10ì´ˆë§ˆë‹¤ ê°±ì‹  */
  fetchPrice();
  setInterval(fetchPrice, 10000);
})();
</script>
{% endif %}
{% endblock %}
