{% extends "base.html" %}
{% block title %}{{ stock.ticker }} ìƒì„¸ â€” ë¯¸êµ­ì£¼ì‹ ì¶”ì²œ{% endblock %}

{% block content %}

<div class="mb-3">
  <a href="/" class="btn btn-outline-secondary btn-sm">â† ëŒ€ì‹œë³´ë“œ</a>
</div>

{% if stock.error %}
  <div class="alert alert-danger">{{ stock.ticker }} ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {{ stock.error }}</div>
{% else %}

<!-- í—¤ë” -->
<div class="d-flex align-items-baseline gap-3 mb-3 flex-wrap">
  <h3 class="mb-0">{{ stock.ticker }}</h3>
  <span class="text-muted">{{ stock.name }}</span>
  <!-- í˜„ì¬ê°€: AJAXë¡œ 10ì´ˆë§ˆë‹¤ ê°±ì‹  -->
  <span id="detailPrice" class="fs-4 fw-bold"
    data-ticker="{{ stock.ticker }}"
    data-price="{{ stock.current_price }}">
    ${{ "%.2f"|format(stock.current_price) }}
  </span>
  <!-- ì „ì¼ ëŒ€ë¹„ ë³€ë™ë¥  (AJAXê°€ ì±„ì›Œì¤Œ) -->
  <span id="detailChange" class="small"></span>
  {% if stock.sector %}
    <span class="badge bg-secondary">{{ stock.sector }}</span>
  {% endif %}
  <span id="detailUpdatedAt" class="text-muted small"></span>
</div>

<!-- ì¶”ì²œ ì ìˆ˜ ì¹´ë“œ -->
<div class="card mb-4 p-3 border-2" style="border-color:{{ score.grade_color }}!important">
  <div class="row align-items-center g-3">
    <div class="col-auto text-center">
      <div class="text-muted small">ì¢…í•© ì¶”ì²œ ì ìˆ˜</div>
      <div class="display-4 fw-bold" style="color:{{ score.grade_color }}">{{ score.total_score }}</div>
      <span class="badge fs-6 grade-badge"
        style="background:{{ score.grade_color }}; cursor:pointer"
        data-ticker="{{ stock.ticker }}"
        data-name="{{ stock.name }}"
        data-total="{{ score.total_score }}"
        data-grade="{{ score.grade }}"
        data-grade-color="{{ score.grade_color }}"
        data-fear="{{ score.fear_score }}"
        data-drawdown-score="{{ score.drawdown_score }}"
        data-fundamental="{{ score.fundamental_score if score.fundamental_score is not none else '' }}"
        data-recession="{{ score.recession_penalty if score.recession_penalty is defined else 0 }}"
        data-ath-drawdown="{{ stock.ath_drawdown_pct }}"
        data-buy-ratio="{{ stock.buy_ratio_pct if stock.buy_ratio_pct is not none else '' }}"
        data-forward-pe="{{ stock.forward_pe if stock.forward_pe is not none else '' }}"
        data-roe="{{ stock.roe if (stock.roe is defined and stock.roe is not none) else '' }}"
        data-peg="{{ stock.peg if (stock.peg is defined and stock.peg is not none) else '' }}"
        data-fcf="{{ 'ì–‘í˜¸' if stock.fcf_positive else 'ë¶€ì¡±' }}"
        data-is-etf="{{ 'true' if stock.is_etf else 'false' }}"
        data-reason="{{ score.reason }}">
        {{ score.grade }}
      </span>
    </div>
    <div class="col">
      <div class="mb-2 text-muted small">ê·¼ê±°: {{ score.reason }}</div>
      <div class="row g-2">
        <div class="col-4 text-center">
          <div class="small text-muted">ê³µí¬ ì ìˆ˜</div>
          <div class="fw-bold">{{ score.fear_score }}/100</div>
          <div class="progress mt-1" style="height:6px">
            <div class="progress-bar bg-danger" style="width:{{ score.fear_score }}%"></div>
          </div>
        </div>
        <div class="col-4 text-center">
          <div class="small text-muted">ë‚™í­ ì ìˆ˜</div>
          <div class="fw-bold">{{ score.drawdown_score }}/100</div>
          <div class="progress mt-1" style="height:6px">
            <div class="progress-bar bg-warning" style="width:{{ score.drawdown_score }}%"></div>
          </div>
        </div>
        <div class="col-4 text-center">
          <div class="small text-muted">í€ë”ë©˜íƒˆ</div>
          <div class="fw-bold">{{ score.fundamental_score }}/100</div>
          <div class="progress mt-1" style="height:6px">
            <div class="progress-bar bg-success" style="width:{{ score.fundamental_score }}%"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ì°¨íŠ¸ + ë‚™í­ -->
<div class="row g-3 mb-4">
  <div class="col-md-8">
    <div class="card p-3 h-100">
      <!-- ì´ë™í‰ê·  ë²”ë¡€ -->
      <div class="d-flex align-items-center gap-3 mb-2 flex-wrap">
        <span class="small text-muted">1ë…„ ì£¼ê°€ ì¶”ì´</span>
        <span class="small"><span style="color:#3498db">â”</span> ì¢…ê°€</span>
        <span class="small"><span style="color:#e67e22">â”</span> MA20</span>
        <span class="small"><span style="color:#9b59b6">â”</span> MA60</span>
        <span class="small"><span style="color:#e74c3c">â”</span> MA120</span>
      </div>
      <!-- ì£¼ê°€ + ì´ë™í‰ê·  ì°¨íŠ¸ -->
      <canvas id="priceChart" style="max-height:240px"></canvas>
      <!-- ê±°ë˜ëŸ‰ ì°¨íŠ¸ -->
      <div class="small text-muted mt-3 mb-1">ê±°ë˜ëŸ‰</div>
      <canvas id="volumeChart" style="max-height:80px"></canvas>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card p-3 h-100">
      <div class="small text-muted mb-2">ê³ ì  ëŒ€ë¹„ ë‚™í­</div>
      <table class="table table-sm">
        <tr>
          <td class="text-muted">í˜„ì¬ê°€</td>
          <td class="fw-bold">${{ "%.2f"|format(stock.current_price) }}</td>
        </tr>
        <tr>
          <td class="text-muted">ì—­ëŒ€ ìµœê³ ê°€(ATH)</td>
          <td>${{ "%.2f"|format(stock.ath) }} <span class="text-muted small">({{ stock.ath_date }})</span></td>
        </tr>
        <tr>
          <td class="text-muted">ATH ëŒ€ë¹„ ë‚™í­</td>
          <td class="fw-bold {% if stock.ath_drawdown_pct <= -30 %}text-danger{% elif stock.ath_drawdown_pct <= -15 %}text-warning{% endif %}">
            {{ stock.ath_drawdown_pct }}%
          </td>
        </tr>
        <tr>
          <td class="text-muted">52ì£¼ ìµœê³ ê°€</td>
          <td>${{ "%.2f"|format(stock.high_52w) }}</td>
        </tr>
        <tr>
          <td class="text-muted">52ì£¼ ê³ ì  ëŒ€ë¹„</td>
          <td class="{% if stock.high_52w_drawdown_pct <= -15 %}text-warning{% endif %}">
            {{ stock.high_52w_drawdown_pct }}%
          </td>
        </tr>
      </table>
    </div>
  </div>
</div>

<!-- í€ë”ë©˜íƒˆ + ì• ë„ë¦¬ìŠ¤íŠ¸ -->
<div class="row g-3 mb-4">
  <div class="col-md-5">
    <div class="card p-3 h-100">
      {% if stock.is_etf %}
        <div class="small text-muted mb-2">ETF ì§€í‘œ <span class="badge bg-info text-dark ms-1">ETF</span></div>
        <table class="table table-sm">
          <tr>
            <td class="text-muted">Trailing PER</td>
            <td>{{ stock.trailing_pe if stock.trailing_pe else 'N/A' }}</td>
          </tr>
          <tr>
            <td class="text-muted">YTD ìˆ˜ìµë¥ </td>
            <td class="{% if stock.ytd_return and stock.ytd_return > 0 %}text-success{% elif stock.ytd_return %}text-danger{% endif %}">
              {{ ('+' if stock.ytd_return and stock.ytd_return > 0 else '') + stock.ytd_return|string + '%' if stock.ytd_return is not none else 'N/A' }}
            </td>
          </tr>
          <tr>
            <td class="text-muted">3ë…„ í‰ê·  ìˆ˜ìµë¥ </td>
            <td class="{% if stock.three_year_return and stock.three_year_return > 0 %}text-success{% elif stock.three_year_return %}text-danger{% endif %}">
              {{ ('+' if stock.three_year_return and stock.three_year_return > 0 else '') + stock.three_year_return|string + '%' if stock.three_year_return is not none else 'N/A' }}
            </td>
          </tr>
          <tr>
            <td class="text-muted">ìš´ìš©ìì‚° (AUM)</td>
            <td>
              {% if stock.total_assets %}
                ${{ "%.1fB"|format(stock.total_assets / 1e9) if stock.total_assets >= 1e9 else "%.0fM"|format(stock.total_assets / 1e6) }}
              {% else %}N/A{% endif %}
            </td>
          </tr>
        </table>
        <div class="alert alert-light p-2 small mt-1 mb-0">
          ETFëŠ” í€ë”ë©˜íƒˆ ì ìˆ˜ ëŒ€ì‹  <strong>ì‹œì¥ ê³µí¬ + ë‚™í­</strong> ê¸°ì¤€ìœ¼ë¡œ ì ìˆ˜ë¥¼ ì‚°ì¶œí•©ë‹ˆë‹¤.
        </div>
      {% else %}
        <div class="small text-muted mb-2">í€ë”ë©˜íƒˆ ì§€í‘œ</div>
        <table class="table table-sm">
          <tr>
            <td class="text-muted"
              data-bs-toggle="tooltip"
              data-bs-title="í–¥í›„ 12ê°œì›” ì˜ˆìƒ ì‹¤ì  ê¸°ì¤€ ì£¼ê°€ìˆ˜ìµë¹„ìœ¨. ë‚®ì„ìˆ˜ë¡ ì €í‰ê°€. ì—…ì¢… í‰ê·  ëŒ€ë¹„ íŒë‹¨ ê¶Œì¥">
              Forward PER â„¹
            </td>
            <td class="fw-bold">{{ stock.forward_pe if stock.forward_pe else 'N/A' }}</td>
          </tr>
          <tr>
            <td class="text-muted"
              data-bs-toggle="tooltip"
              data-bs-title="ê³¼ê±° 12ê°œì›” ì‹¤ì  ê¸°ì¤€ ì£¼ê°€ìˆ˜ìµë¹„ìœ¨. Forward PERë³´ë‹¤ í˜„ì‹¤ì ì´ë‚˜ ê³¼ê±° ì§€í‘œì„">
              Trailing PER â„¹
            </td>
            <td>{{ stock.trailing_pe if stock.trailing_pe else 'N/A' }}</td>
          </tr>
          <tr>
            <td class="text-muted"
              data-bs-toggle="tooltip"
              data-bs-title="PEG = PER Ã· EPSì„±ì¥ë¥ . 1 ë¯¸ë§Œì´ë©´ ì„±ì¥ ëŒ€ë¹„ ì €í‰ê°€, 2 ì´ìƒì´ë©´ ê³ í‰ê°€ ì‹ í˜¸">
              PEG â„¹
            </td>
            {% set peg_val = stock.peg if (stock.peg is defined and stock.peg) else none %}
            <td class="{% if peg_val and peg_val < 1 %}text-success fw-bold{% elif peg_val and peg_val > 2 %}text-danger{% endif %}">
              {% if peg_val %}
                {{ peg_val }}
                {% if peg_val < 1 %}<span class="badge bg-success ms-1" style="font-size:0.65rem">ì €í‰ê°€</span>{% endif %}
              {% else %}N/A{% endif %}
            </td>
          </tr>
          <tr>
            <td class="text-muted"
              data-bs-toggle="tooltip"
              data-bs-title="ìê¸°ìë³¸ì´ìµë¥ . ìˆœì´ìµ Ã· ìê¸°ìë³¸. 15% ì´ìƒì´ë©´ ìš°ëŸ‰, ë†’ì„ìˆ˜ë¡ ìë³¸ íš¨ìœ¨ì„± ì¢‹ìŒ">
              ROE â„¹
            </td>
            {% set roe_val = stock.roe if (stock.roe is defined and stock.roe is not none) else none %}
            <td class="{% if roe_val is not none and roe_val >= 15 %}text-success{% elif roe_val is not none and roe_val < 0 %}text-danger{% endif %}">
              {{ roe_val|string + '%' if roe_val is not none else 'N/A' }}
            </td>
          </tr>
          <tr>
            <td class="text-muted"
              data-bs-toggle="tooltip"
              data-bs-title="ì£¼ë‹¹ìˆœì´ìµ ì¦ê°€ìœ¨(ì „ë…„ ë™ê¸° ëŒ€ë¹„). 10% ì´ìƒì´ë©´ ê³ ì„±ì¥, ë†’ì„ìˆ˜ë¡ ì„±ì¥ì„± ìš°ìˆ˜">
              EPS ì„±ì¥ë¥  â„¹
            </td>
            <td class="{% if stock.eps_growth_pct and stock.eps_growth_pct > 0 %}text-success{% elif stock.eps_growth_pct %}text-danger{% endif %}">
              {{ ('+' if stock.eps_growth_pct and stock.eps_growth_pct > 0 else '') + stock.eps_growth_pct|string + '%' if stock.eps_growth_pct is not none else 'N/A' }}
            </td>
          </tr>
          <tr>
            <td class="text-muted"
              data-bs-toggle="tooltip"
              data-bs-title="ì „ë…„ ëŒ€ë¹„ ë§¤ì¶œ ì¦ê°€ìœ¨. ì§€ì†ì  ë§¤ì¶œ ì„±ì¥ì´ ì£¼ê°€ ìƒìŠ¹ì˜ ê¸°ë°˜">
              ë§¤ì¶œ ì„±ì¥ë¥  â„¹
            </td>
            <td class="{% if stock.revenue_growth_pct and stock.revenue_growth_pct > 0 %}text-success{% endif %}">
              {{ ('+' if stock.revenue_growth_pct and stock.revenue_growth_pct > 0 else '') + stock.revenue_growth_pct|string + '%' if stock.revenue_growth_pct is not none else 'N/A' }}
            </td>
          </tr>
          <tr>
            <td class="text-muted"
              data-bs-toggle="tooltip"
              data-bs-title="ì‰ì—¬í˜„ê¸ˆíë¦„. ì˜ì—…í™œë™ í›„ ë‚¨ì€ í˜„ê¸ˆ. ì–‘ìˆ˜ì¼ìˆ˜ë¡ ì¬ë¬´ê±´ì „, ë°°ë‹¹Â·ìì‚¬ì£¼ë§¤ì… ì—¬ë ¥">
              FCF â„¹
            </td>
            <td class="{% if stock.fcf_positive %}text-success{% else %}text-danger{% endif %}">
              {% if stock.free_cash_flow is not none %}
                {{ '+' if stock.fcf_positive else '' }}${{ "%.1fB"|format(stock.free_cash_flow / 1e9) if stock.free_cash_flow|abs >= 1e9 else "%.0fM"|format(stock.free_cash_flow / 1e6) }}
              {% else %}N/A{% endif %}
            </td>
          </tr>
        </table>
      {% endif %}
    </div>
  </div>
  <div class="col-md-7">
    <div class="card p-3 h-100">
      <div class="small text-muted mb-2">ì• ë„ë¦¬ìŠ¤íŠ¸ íˆ¬ìì˜ê²¬ (ì´ {{ stock.analyst_count }}ëª…)</div>
      {% if stock.analyst_count > 0 %}
        {% set total = stock.strong_buy + stock.buy + stock.hold + stock.sell + stock.strong_sell %}
        {% if total > 0 %}
          <div class="mb-2">
            <div class="d-flex mb-1" style="height:22px; border-radius:4px; overflow:hidden">
              {% if stock.strong_buy %}
                <div class="bg-success" style="width:{{ (stock.strong_buy/total*100)|round }}%;opacity:.9" title="Strong Buy: {{stock.strong_buy}}"></div>
              {% endif %}
              {% if stock.buy %}
                <div class="bg-success" style="width:{{ (stock.buy/total*100)|round }}%" title="Buy: {{stock.buy}}"></div>
              {% endif %}
              {% if stock.hold %}
                <div class="bg-warning" style="width:{{ (stock.hold/total*100)|round }}%" title="Hold: {{stock.hold}}"></div>
              {% endif %}
              {% if stock.sell %}
                <div class="bg-danger" style="width:{{ (stock.sell/total*100)|round }}%;opacity:.8" title="Sell: {{stock.sell}}"></div>
              {% endif %}
              {% if stock.strong_sell %}
                <div class="bg-danger" style="width:{{ (stock.strong_sell/total*100)|round }}%" title="Strong Sell: {{stock.strong_sell}}"></div>
              {% endif %}
            </div>
            <div class="d-flex gap-3 small">
              <span class="text-success">Strong Buy {{ stock.strong_buy }}</span>
              <span class="text-success">Buy {{ stock.buy }}</span>
              <span class="text-warning">Hold {{ stock.hold }}</span>
              <span class="text-danger">Sell {{ stock.sell + stock.strong_sell }}</span>
            </div>
          </div>
        {% endif %}
        <table class="table table-sm mt-2">
          <tr>
            <td class="text-muted">Buy ë¹„ìœ¨</td>
            <td class="fw-bold {% if stock.buy_ratio_pct and stock.buy_ratio_pct >= 70 %}text-success{% endif %}">
              {{ stock.buy_ratio_pct ~ '%' if stock.buy_ratio_pct is not none else 'N/A' }}
            </td>
          </tr>
          <tr>
            <td class="text-muted">í‰ê·  ëª©í‘œì£¼ê°€</td>
            <td class="fw-bold">${{ "%.2f"|format(stock.target_price) if stock.target_price else 'N/A' }}</td>
          </tr>
          <tr>
            <td class="text-muted">ëª©í‘œê°€ Upside</td>
            <td class="{% if stock.target_upside_pct and stock.target_upside_pct > 0 %}text-success{% elif stock.target_upside_pct %}text-danger{% endif %} fw-bold">
              {{ ('+' if stock.target_upside_pct and stock.target_upside_pct > 0 else '') + stock.target_upside_pct|string + '%' if stock.target_upside_pct is not none else 'N/A' }}
            </td>
          </tr>
        </table>
      {% else %}
        <div class="text-muted small">ì• ë„ë¦¬ìŠ¤íŠ¸ ë°ì´í„° ì—†ìŒ (ETF ë˜ëŠ” ë°ì´í„° ë¯¸ì œê³µ)</div>
      {% endif %}
    </div>
  </div>
</div>

<!-- ì™¸ë¶€ ë§í¬ -->
<div class="mb-4">
  <div class="small text-muted mb-1">ì™¸ë¶€ ë¦¬ì„œì¹˜</div>
  <div class="d-flex gap-2">
    <a href="https://finance.yahoo.com/quote/{{ stock.ticker }}" target="_blank" class="btn btn-outline-primary btn-sm">Yahoo Finance</a>
    <a href="https://www.investing.com/search/?q={{ stock.ticker }}" target="_blank" class="btn btn-outline-secondary btn-sm">Investing.com</a>
    <a href="https://seekingalpha.com/symbol/{{ stock.ticker }}" target="_blank" class="btn btn-outline-secondary btn-sm">Seeking Alpha</a>
  </div>
</div>

<!-- ì¥ë‹¨ê¸° ê¸ˆë¦¬ì°¨ íŒ¨ë„í‹° í‘œì‹œ -->
{% if yield_curve and yield_curve.available and yield_curve.status != 'normal' %}
<div class="alert alert-{% if yield_curve.status == 'deeply_inverted' %}danger{% elif yield_curve.status == 'inverted' %}warning{% else %}info{% endif %} py-2 small mb-3">
  <strong>ì¥ë‹¨ê¸° ê¸ˆë¦¬ì°¨:</strong>
  {{ '%+.2f'|format(yield_curve.spread) }}% ({{ yield_curve.status_label }})
  &nbsp;|&nbsp; 10Y {{ yield_curve.rate_10y }}% / 2Y {{ yield_curve.rate_2y }}%
  {% if score.recession_penalty > 0 %}
    &nbsp;â†’ <strong>ì¶”ì²œ ì ìˆ˜ -{{ score.recession_penalty }}ì  ë°˜ì˜</strong>
  {% endif %}
</div>
{% endif %}

<div class="text-muted small">
  ë§ˆì§€ë§‰ ê°±ì‹ : {{ stock.updated }} &nbsp;|&nbsp;
  â€» ë³¸ ì •ë³´ëŠ” íˆ¬ì ì˜ì‚¬ê²°ì • ì°¸ê³ ìš©ì´ë©°, íˆ¬ì ì†ìµì— ëŒ€í•œ ì±…ì„ì€ íˆ¬ìì ë³¸ì¸ì—ê²Œ ìˆìŠµë‹ˆë‹¤.
</div>

<!-- â”€â”€ ë“±ê¸‰ ìƒì„¸ ë¶„ì„ ëª¨ë‹¬ â”€â”€ -->
<div class="modal fade" id="gradeModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header" id="modalHeader">
        <h5 class="modal-title" id="modalTitle">ì¢…ëª© ë¶„ì„</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- JSê°€ ì±„ì›Œì¤Œ -->
      </div>
      <div class="modal-footer">
        <small class="text-muted me-auto">â€» ê·œì¹™ ê¸°ë°˜ ì ìˆ˜ë¡œ íˆ¬ì ê²°ì •ì˜ ì°¸ê³  ìë£Œì…ë‹ˆë‹¤.</small>
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">ë‹«ê¸°</button>
      </div>
    </div>
  </div>
</div>

{% endif %}
{% endblock %}

{% block scripts %}
<script>
/* Bootstrap íˆ´íŒ ì´ˆê¸°í™” */
document.addEventListener("DOMContentLoaded", function () {
  document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(function (el) {
    new bootstrap.Tooltip(el, { placement: "top", trigger: "hover", html: true, sanitize: false });
  });
});

/* â”€â”€ ë“±ê¸‰ ë°°ì§€ í´ë¦­ â†’ ëª¨ë‹¬ ìƒì„¸ ë¶„ì„ â”€â”€ */
document.addEventListener("click", function (e) {
  var badge = e.target.closest(".grade-badge");
  if (!badge) return;

  var ticker     = badge.dataset.ticker;
  var name       = badge.dataset.name;
  var total      = parseInt(badge.dataset.total);
  var grade      = badge.dataset.grade;
  var gradeColor = badge.dataset.gradeColor;
  var fear       = parseInt(badge.dataset.fear);
  var ddScore    = parseInt(badge.dataset.drawdownScore);
  var fundScore  = badge.dataset.fundamental !== "" ? parseInt(badge.dataset.fundamental) : null;
  var recession  = parseInt(badge.dataset.recession || "0");
  var athDd      = parseFloat(badge.dataset.athDrawdown);
  var buyRatio   = badge.dataset.buyRatio !== "" ? parseFloat(badge.dataset.buyRatio) : null;
  var fpe        = badge.dataset.forwardPe !== "" ? parseFloat(badge.dataset.forwardPe) : null;
  var roe        = badge.dataset.roe !== "" ? parseFloat(badge.dataset.roe) : null;
  var peg        = badge.dataset.peg !== "" ? parseFloat(badge.dataset.peg) : null;
  var fcf        = badge.dataset.fcf;
  var isEtf      = badge.dataset.isEtf === "true";
  var reason     = badge.dataset.reason;

  document.getElementById("modalHeader").style.background = gradeColor + "22";
  document.getElementById("modalTitle").innerHTML =
    ticker + " <small class='text-muted'>" + name.substring(0, 30) + "</small>" +
    " &nbsp;<span class='badge' style='background:" + gradeColor + "'>" + grade + "</span>";

  function fearDesc(s) {
    if (s >= 70) return "ì‹œì¥ ê·¹ë„ ê³µí¬ â€” ì—­ì‚¬ì  ì €ì  ê·¼ì²˜ ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.";
    if (s >= 50) return "ì‹œì¥ ë¶ˆì•ˆÂ·í•˜ë½ â€” ê³µí¬ ë¶„ìœ„ê¸°ê°€ í¼ì ¸ ìˆëŠ” ìƒíƒœì…ë‹ˆë‹¤.";
    if (s >= 30) return "ë‹¤ì†Œ ë¶ˆì•ˆ â€” í•˜ë½ ì••ë ¥ì´ ìˆìœ¼ë‚˜ ì•„ì§ ê³µí¬ ìˆ˜ì¤€ì€ ì•„ë‹™ë‹ˆë‹¤.";
    return "ì‹œì¥ ì•ˆì •Â·íƒìš• ìƒíƒœ â€” ë§¤ìˆ˜ íƒ€ì´ë°ìœ¼ë¡œëŠ” ë¶ˆë¦¬í•©ë‹ˆë‹¤.";
  }
  function ddDesc(d) {
    if (d == null) return "ë‚™í­ ë°ì´í„° ì—†ìŒ";
    var pct = Math.abs(d);
    if (pct >= 50) return "ATH ëŒ€ë¹„ " + d + "% â€” ë°˜í† ë§‰ ìˆ˜ì¤€, ê°•ë ¥í•œ ë§¤ìˆ˜ êµ¬ê°„";
    if (pct >= 30) return "ATH ëŒ€ë¹„ " + d + "% â€” í° ì¡°ì •, ë§¤ìˆ˜ ì ê·¹ ê²€í†  êµ¬ê°„";
    if (pct >= 20) return "ATH ëŒ€ë¹„ " + d + "% â€” ì¤‘ê°„ ì¡°ì •, ë§¤ìˆ˜ ê³ ë ¤ ê°€ëŠ¥";
    if (pct >= 10) return "ATH ëŒ€ë¹„ " + d + "% â€” ì†Œí­ ì¡°ì •, ì¶©ë¶„í•œ í•˜ë½ ì•„ë‹˜";
    return "ATH ëŒ€ë¹„ " + d + "% â€” ê³ ì  ê·¼ì²˜, ë§¤ìˆ˜ ì£¼ì˜";
  }
  function fundDesc(score, buy, pe, roe, peg, fcf) {
    if (score == null) return "ETF â€” í€ë”ë©˜íƒˆ í‰ê°€ ì œì™¸ (Fear + ë‚™í­ë§Œ ì ìš©)";
    var parts = [];
    if (buy != null) parts.push("Buyë¹„ìœ¨ " + buy + "%" + (buy >= 70 ? " âœ“" : ""));
    if (pe  != null) parts.push("Forward PE " + pe + (pe < 20 ? " âœ“" : pe > 30 ? " âœ—" : ""));
    if (roe != null) parts.push("ROE " + roe + "%" + (roe >= 15 ? " âœ“" : ""));
    if (peg != null) parts.push("PEG " + peg + (peg < 1 ? " âœ“ì €í‰ê°€" : peg > 2 ? " âœ—ê³ í‰ê°€" : ""));
    if (fcf)         parts.push("FCF " + fcf + (fcf === "ì–‘í˜¸" ? " âœ“" : " âœ—"));
    return parts.length ? parts.join(" &nbsp;|&nbsp; ") : "ë°ì´í„° ë¶€ì¡±";
  }
  function recessionDesc(penalty) {
    if (penalty >= 25) return "ì¥ë‹¨ê¸° ê¸ˆë¦¬ì°¨ ì‹¬ê° ì—­ì „ â€” ê²½ê¸°ì¹¨ì²´ ê°•í•œ ê²½ê³  ì‹ í˜¸ (-25ì  ë°˜ì˜)";
    if (penalty >= 15) return "ì¥ë‹¨ê¸° ê¸ˆë¦¬ì°¨ ì—­ì „ â€” ì¹¨ì²´ ì„ í–‰ì§€í‘œ ë°œë™ (-15ì  ë°˜ì˜)";
    if (penalty >= 5)  return "ì¥ë‹¨ê¸° ê¸ˆë¦¬ì°¨ í”Œë«í™” â€” ê²½ê¸° ë‘”í™” ì£¼ì˜ (-5ì  ë°˜ì˜)";
    return "ì¥ë‹¨ê¸° ê¸ˆë¦¬ì°¨ ì •ìƒ â€” ì¹¨ì²´ íŒ¨ë„í‹° ì—†ìŒ";
  }
  function gradeDesc(g) {
    if (g.includes("ê°•ë ¥")) return "ì‹œì¥ ê³µí¬ + í° ë‚™í­ + ìš°ìˆ˜í•œ í€ë”ë©˜íƒˆì´ ë™ì‹œì— ì¶©ì¡±ëœ ìµœì  ë§¤ìˆ˜ íƒ€ì´ë°ì…ë‹ˆë‹¤. ë¶„í•  ë§¤ìˆ˜ë¥¼ ì ê·¹ ê³ ë ¤í•˜ì„¸ìš”.";
    if (g.includes("ë§¤ìˆ˜ ê³ ë ¤")) return "ì¼ë¶€ ì¡°ê±´ì´ ì¶©ì¡±ëœ ë§¤ìˆ˜ ê³ ë ¤ êµ¬ê°„ì…ë‹ˆë‹¤. ì¶”ê°€ í•˜ë½ ê°€ëŠ¥ì„±ì„ ê³ ë ¤í•´ ì†ŒëŸ‰ë¶€í„° ë¶„í•  ì ‘ê·¼ì„ ê¶Œì¥í•©ë‹ˆë‹¤.";
    if (g.includes("ê´€ë§")) return "ë§¤ìˆ˜ ì¡°ê±´ì´ ë¶€ë¶„ì ìœ¼ë¡œë§Œ ì¶©ì¡±ë©ë‹ˆë‹¤. ì‹œì¥ ìƒí™©ì„ ë” ì§€ì¼œë³´ê±°ë‚˜ í•˜ë½ ì‹œ ì¤€ë¹„í•˜ëŠ” ë‹¨ê³„ì…ë‹ˆë‹¤.";
    return "í˜„ì¬ ë§¤ìˆ˜ ì¡°ê±´ì´ ë¶ˆì¶©ë¶„í•©ë‹ˆë‹¤. ì‹œì¥ ì•ˆì • ë˜ëŠ” ê°€ê²© ì¡°ì •ì„ ê¸°ë‹¤ë¦¬ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.";
  }
  function progressBar(score, max, color) {
    var pct = max > 0 ? Math.round(score / max * 100) : 0;
    return '<div class="progress" style="height:10px"><div class="progress-bar" style="width:' +
      pct + '%;background:' + color + '">' + score + '/' + max + '</div></div>';
  }

  var baseScore = total + recession;
  var html = '';

  html += '<div class="mb-4">';
  html += '<div class="d-flex align-items-center gap-3 mb-2">';
  html += '<div class="text-center" style="min-width:80px">';
  html += '<div class="display-4 fw-bold" style="color:' + gradeColor + '">' + total + '</div>';
  html += '<div class="small text-muted">/ 100ì </div></div>';
  html += '<div class="flex-grow-1">';
  html += progressBar(total, 100, gradeColor);
  html += '<div class="mt-2 small">' + gradeDesc(grade) + '</div>';
  html += '</div></div>';
  if (recession > 0) {
    html += '<div class="alert alert-warning py-1 small mb-0">âš  ì¹¨ì²´ íŒ¨ë„í‹° -' + recession + 'ì  ì°¨ê° (ì›ì ìˆ˜: ' + baseScore + 'ì )</div>';
  }
  html += '</div>';

  html += '<div class="row g-3 mb-3">';
  html += '<div class="col-md-4"><div class="card p-3 h-100 border-danger border-opacity-25">';
  html += '<div class="small fw-bold text-danger mb-1">ğŸ”´ ì‹œì¥ ê³µí¬ ì ìˆ˜ &nbsp;' + fear + '/100</div>';
  html += progressBar(fear, 100, "#e74c3c");
  html += '<div class="small text-muted mt-2">' + fearDesc(fear) + '</div>';
  html += '</div></div>';

  html += '<div class="col-md-4"><div class="card p-3 h-100 border-warning border-opacity-25">';
  html += '<div class="small fw-bold text-warning mb-1">ğŸŸ  ë‚™í­ ì ìˆ˜ &nbsp;' + ddScore + '/100</div>';
  html += progressBar(ddScore, 100, "#f39c12");
  html += '<div class="small text-muted mt-2">' + ddDesc(athDd) + '</div>';
  html += '</div></div>';

  html += '<div class="col-md-4"><div class="card p-3 h-100 border-success border-opacity-25">';
  html += '<div class="small fw-bold text-success mb-1">ğŸŸ¢ í€ë”ë©˜íƒˆ ' +
    (fundScore != null ? fundScore + '/100' : 'ETF') + '</div>';
  if (fundScore != null) html += progressBar(fundScore, 100, "#27ae60");
  html += '<div class="small text-muted mt-2">' + fundDesc(fundScore, buyRatio, fpe, roe, peg, fcf) + '</div>';
  html += '</div></div>';
  html += '</div>';

  html += '<div class="card p-3 mb-3 border-' +
    (recession >= 25 ? "danger" : recession >= 15 ? "warning" : recession >= 5 ? "info" : "success") +
    ' border-opacity-25">';
  html += '<div class="small fw-bold mb-1">ğŸ“Š ê²½ê¸°ì¹¨ì²´ ë¦¬ìŠ¤í¬</div>';
  html += '<div class="small text-muted">' + recessionDesc(recession) + '</div>';
  html += '</div>';

  html += '<div class="card bg-light p-3 small">';
  html += '<div class="fw-bold mb-1">ğŸ“ ì ìˆ˜ ê³„ì‚°ì‹</div>';
  if (isEtf) {
    html += '<code>' + fear + ' Ã— 0.5 + ' + ddScore + ' Ã— 0.5 = ' + baseScore + 'ì </code>';
    html += ' (ETF: ê³µí¬Â·ë‚™í­ë§Œ ì ìš©)';
  } else {
    html += '<code>' + fear + ' Ã— 0.3 + ' + ddScore + ' Ã— 0.4 + ' +
      (fundScore || 0) + ' Ã— 0.3 = ' + baseScore + 'ì </code>';
    html += ' (ì£¼ì‹: ê³µí¬Â·ë‚™í­Â·í€ë”ë©˜íƒˆ)';
  }
  if (recession > 0) html += ' &nbsp;- <span class="text-danger">' + recession + 'ì (ì¹¨ì²´íŒ¨ë„í‹°)</span> = <strong>' + total + 'ì </strong>';
  html += '</div>';

  document.getElementById("modalBody").innerHTML = html;

  /* ëª¨ë‹¬ ì§ì ‘ ì—´ê¸° */
  var modalEl = document.getElementById("gradeModal");
  var modal = bootstrap.Modal.getOrCreateInstance(modalEl);
  modal.show();
});
</script>
{% if stock.price_history %}
<script>
(function () {
  /* â”€â”€ ì°¨íŠ¸ ë°ì´í„° ì¤€ë¹„ â”€â”€ */
  var history = {{ stock.price_history | tojson }};
  var labels  = history.map(function(d) { return d.date; });
  var prices  = history.map(function(d) { return d.close; });
  var volumes = history.map(function(d) { return d.volume || 0; });
  var ma20    = history.map(function(d) { return d.ma20; });
  var ma60    = history.map(function(d) { return d.ma60; });
  var ma120   = history.map(function(d) { return d.ma120; });

  /* xì¶• ëˆˆê¸ˆ: ì›” ë‹¨ìœ„ë¡œ í‘œì‹œ */
  var xLabels = labels.map(function(d, i) {
    if (i === 0) return d.slice(0, 7);
    return labels[i].slice(5, 7) !== labels[i-1].slice(5, 7) ? d.slice(0, 7) : '';
  });

  /* â”€â”€ ì£¼ê°€ + ì´ë™í‰ê·  ì°¨íŠ¸ â”€â”€ */
  new Chart(document.getElementById('priceChart'), {
    type: 'line',
    data: {
      labels: xLabels,
      datasets: [
        {
          /* ì¢…ê°€ (ë©”ì¸ ë¼ì¸ + ë°°ê²½ ì±„ìš°ê¸°) */
          label: 'ì¢…ê°€',
          data: prices,
          borderColor: '#3498db',
          backgroundColor: 'rgba(52,152,219,0.07)',
          borderWidth: 1.5,
          pointRadius: 0,
          fill: true,
          tension: 0.2,
          order: 4,
        },
        {
          /* 20ì¼ ì´ë™í‰ê·  */
          label: 'MA20',
          data: ma20,
          borderColor: '#e67e22',
          borderWidth: 1.2,
          pointRadius: 0,
          fill: false,
          tension: 0.2,
          order: 3,
        },
        {
          /* 60ì¼ ì´ë™í‰ê·  */
          label: 'MA60',
          data: ma60,
          borderColor: '#9b59b6',
          borderWidth: 1.2,
          pointRadius: 0,
          fill: false,
          tension: 0.2,
          order: 2,
        },
        {
          /* 120ì¼ ì´ë™í‰ê·  */
          label: 'MA120',
          data: ma120,
          borderColor: '#e74c3c',
          borderWidth: 1.5,
          pointRadius: 0,
          fill: false,
          tension: 0.2,
          order: 1,
        },
      ]
    },
    options: {
      responsive: true,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            /* íˆ´íŒì—ì„œ null ê°’ ì œì™¸ */
            label: function(ctx) {
              if (ctx.parsed.y === null) return null;
              return ctx.dataset.label + ': $' + ctx.parsed.y.toFixed(2);
            }
          }
        }
      },
      scales: {
        x: { ticks: { maxTicksLimit: 8, maxRotation: 0 } },
        y: { ticks: { callback: function(v) { return '$' + v; } } }
      }
    }
  });

  /* â”€â”€ ê±°ë˜ëŸ‰ ì°¨íŠ¸ â”€â”€ */
  /* ê±°ë˜ëŸ‰ì´ í‰ê·  ëŒ€ë¹„ 2ë°° ì´ìƒì´ë©´ ê°•ì¡°ìƒ‰ */
  var avgVol = volumes.reduce(function(a, b) { return a + b; }, 0) / volumes.length;
  var volColors = volumes.map(function(v) {
    return v >= avgVol * 2
      ? 'rgba(231,76,60,0.7)'    /* ê¸‰ë“± ê±°ë˜ëŸ‰: ë¹¨ê°• */
      : 'rgba(52,152,219,0.5)';  /* ë³´í†µ ê±°ë˜ëŸ‰: íŒŒë‘ */
  });

  new Chart(document.getElementById('volumeChart'), {
    type: 'bar',
    data: {
      labels: xLabels,
      datasets: [{
        label: 'ê±°ë˜ëŸ‰',
        data: volumes,
        backgroundColor: volColors,
        borderWidth: 0,
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { maxTicksLimit: 8, maxRotation: 0 } },
        y: {
          ticks: {
            /* ê±°ë˜ëŸ‰ ë‹¨ìœ„: M(ë°±ë§Œ) / B(ì‹­ì–µ) */
            callback: function(v) {
              if (v >= 1e9) return (v / 1e9).toFixed(1) + 'B';
              if (v >= 1e6) return (v / 1e6).toFixed(0) + 'M';
              return v;
            }
          }
        }
      }
    }
  });

  /* â”€â”€ ì‹¤ì‹œê°„ ê°€ê²© AJAX ê°±ì‹  (10ì´ˆ ì£¼ê¸°) â”€â”€ */
  var TICKER = '{{ stock.ticker }}';

  function fetchPrice() {
    fetch('/api/prices')
      .then(function(r) { return r.json(); })
      .then(function(data) {
        var item = data[TICKER];
        if (!item || !item.price) return;

        var priceEl  = document.getElementById('detailPrice');
        var changeEl = document.getElementById('detailChange');
        var updEl    = document.getElementById('detailUpdatedAt');

        if (!priceEl) return;

        var oldPrice = parseFloat(priceEl.dataset.price || 0);
        var newPrice = item.price;

        /* ê°€ê²© ë³€ê²½ ì‹œ ì—…ë°ì´íŠ¸ + ë°°ê²½ í”Œë˜ì‹œ */
        if (Math.abs(newPrice - oldPrice) >= 0.01) {
          priceEl.dataset.price = newPrice;
          priceEl.textContent = '$' + newPrice.toFixed(2);

          /* ë°©í–¥ ìƒ‰ìƒ (ì¼ì‹œì ìœ¼ë¡œ) */
          priceEl.style.transition = 'color 0.3s';
          priceEl.style.color = newPrice > oldPrice ? '#27ae60' : '#e74c3c';
          setTimeout(function() { priceEl.style.color = ''; }, 2000);
        }

        /* ì „ì¼ ëŒ€ë¹„ ë³€ë™ë¥  í‘œì‹œ */
        if (changeEl && item.change_pct !== null) {
          var sign  = item.change_pct >= 0 ? '+' : '';
          changeEl.textContent = '(' + sign + item.change_pct + '%)';
          changeEl.className = 'small ' + (item.change_pct >= 0 ? 'text-success' : 'text-danger');
        }

        /* ë§ˆì§€ë§‰ ê°±ì‹  ì‹œê° */
        if (updEl) {
          updEl.textContent = new Date().toLocaleTimeString('ko-KR') + ' ê°±ì‹ ';
        }
      })
      .catch(function() {});
  }

  /* í˜ì´ì§€ ì§„ì… ì¦‰ì‹œ + ì´í›„ 10ì´ˆë§ˆë‹¤ ê°±ì‹  */
  fetchPrice();
  setInterval(fetchPrice, 10000);
})();
</script>
{% endif %}
{% endblock %}
